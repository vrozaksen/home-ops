---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name nextcloud-secret
spec:
  target:
    name: *name
    template:
      data:
        # App
        NEXTCLOUD_ADMIN_USER: "{{ .NEXTCLOUD_ADMIN_USER }}"
        NEXTCLOUD_ADMIN_PASS: "{{ .NEXTCLOUD_ADMIN_PASS }}"
        S3_ACCESS_KEY: "{{ .MINIO_ACCESS_KEY }}"
        S3_SECRET_KEY: "{{ .MINIO_SECRET_KEY }}"
        NEXTCLOUD_OAUTH_CLIENT_ID: "{{ .NEXTCLOUD_CLIENT_ID }}"
        NEXTCLOUD_OAUTH_CLIENT_SECRET: "{{ .NEXTCLOUD_CLIENT_SECRET }}"
        # Mail
        smtp-host: '{{ .SMTP_HOST }}'
        smtp-username: '{{ .SMTP_USER }}'
        smtp-password: '{{ .SMTP_PASS }}'
        # Database
        POSTGRES_USER: '{{ index . "user" }}'
        POSTGRES_PASSWORD: '{{ index . "password" }}'
  dataFrom:
  - extract:
      key: nextcloud
    sourceRef:
       storeRef:
         kind: ClusterSecretStore
         name: bitwarden
  - extract:
      key: nextcloud-bucket
    sourceRef:
      storeRef:
        kind: ClusterSecretStore
        name: bitwarden
  - extract:
      key: protonmail
    sourceRef:
       storeRef:
         kind: ClusterSecretStore
         name: bitwarden
  - extract:
      key: postgres-pguser-nextcloud
    sourceRef:
       storeRef:
         kind: ClusterSecretStore
         name: crunchy-postgres
