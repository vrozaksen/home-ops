---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: clickhouse-s3-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden
  target:
    name: clickhouse-s3-config
    template:
      data:
        storage.xml: |
          <clickhouse>
            <storage_configuration>
              <disks>
                <s3_disk>
                  <type>object_storage</type>
                  <object_storage_type>s3</object_storage_type>
                  <metadata_type>plain_rewritable</metadata_type>
                  <endpoint>https://s3.vzkn.eu/clickhouse</endpoint>
                  <access_key_id>{{ .AWS_ACCESS_KEY_ID }}</access_key_id>
                  <secret_access_key>{{ .AWS_SECRET_ACCESS_KEY }}</secret_access_key>
                  <region>eu-central-1</region>
                </s3_disk>
              </disks>
              <policies>
                <s3_policy>
                  <volumes>
                    <main>
                      <disk>s3_disk</disk>
                    </main>
                  </volumes>
                </s3_policy>
              </policies>
            </storage_configuration>
            <merge_tree>
              <storage_policy>s3_policy</storage_policy>
            </merge_tree>
          </clickhouse>
  dataFrom:
    - extract:
        key: clickhouse-bucket
