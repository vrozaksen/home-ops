---
# yaml-language-server: $schema=https://schemas.vzkn.eu/postgresql.cnpg.io/cluster_v1.json
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: &name postgres-${APP}
spec:
  instances: ${CNPG_REPLICAS:=3}
  imageName: ${CNPG_IMAGE:=ghcr.io/cloudnative-pg/postgresql}:${CNPG_VERSION:=18.0-system-trixie}
  primaryUpdateMethod: switchover
  primaryUpdateStrategy: unsupervised
  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters:
        barmanObjectName: *name
        serverName: *name
  managed:
    services:
      disabledDefaultServices: ${CNPG_DISABLED_SERVICES:=['ro', 'r']}
  storage:
    size: ${CNPG_SIZE:=2Gi}
    storageClass: ${CNPG_STORAGECLASS:=local-hostpath}
  superuserSecret:
    name: ${APP}-cnpg-secret
  enableSuperuserAccess: true
  # Bootstrap method must be provided by a component (initdb or restore)
  resources:
    requests:
      cpu: ${CNPG_REQUESTS_CPU:=25m}
      memory: ${CNPG_REQUESTS_MEMORY:=256Mi}
    limits:
      memory: ${CNPG_LIMITS_MEMORY:=512Mi}
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: required
    nodeSelector:
      kubernetes.io/arch: amd64
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
  postgresql:
    # Synchronous replication - DEFAULT for HA clusters (3 replicas)
    # Provides near-zero data loss with ~1-2ms write latency overhead
    # For single-node: set CNPG_REPLICAS: '1' and comment out entire 'synchronous:' section
    synchronous:
      method: ${CNPG_SYNC_METHOD:=any}
      number: ${CNPG_SYNC_NUMBER:=1}
      dataDurability: ${CNPG_SYNC_DURABILITY:=preferred}
    parameters:
      random_page_cost: ${CNPG_RANDOM_PAGE_COST:="1.1"}
      effective_io_concurrency: ${CNPG_EFFECTIVE_IO_CONCURRENCY:="200"}
  monitoring:
    enablePodMonitor: true
