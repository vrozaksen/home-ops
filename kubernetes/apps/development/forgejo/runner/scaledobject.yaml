---
# yaml-language-server: $schema=https://schemas.vzkn.eu/keda.sh/triggerauthentication_v1alpha1.json
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: forgejo-db-auth
spec:
  secretTargetRef:
    - parameter: connection
      name: postgres-forgejo-app
      key: uri
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/keda.sh/scaledobject_v1alpha1.json
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: forgejo-runner
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: forgejo-runner
  pollingInterval: 15  # Check every 15 seconds for pending jobs
  cooldownPeriod: 300  # Wait 5 minutes before scaling down
  initialCooldownPeriod: 60  # Wait before first scaling to let metrics API stabilize
  minReplicaCount: 1  # Minimum 1 runner always available
  maxReplicaCount: 5  # Maximum 5 runners during high load
  triggers:
    # Scale based on pending jobs in Forgejo database
    - type: postgresql
      metadata:
        query: "SELECT COUNT(*)::int FROM action_run_job WHERE status = 5"
        targetQueryValue: "1"  # 1 runner per pending job
        activationTargetQueryValue: "1"  # Activate scaling when >= 1 pending job
      authenticationRef:
        name: forgejo-db-auth
