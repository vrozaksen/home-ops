---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tetragon-alerts
spec:
  groups:
    - name: tetragon
      interval: 1m
      rules:
        - alert: TetragonAgentDown
          expr: |
            up{job="tetragon"} == 0
          for: 5m
          labels:
            severity: critical
            category: security
          annotations:
            summary: "Tetragon agent is down on {{ $labels.instance }}"
            description: |
              Tetragon security observability agent has been down for more than 5 minutes on node {{ $labels.instance }}.
              Runtime security monitoring is not active!

              Current status: DOWN
              Pod: {{ $labels.pod }}
              Namespace: {{ $labels.namespace }}

        - alert: TetragonHighEventRate
          expr: |
            sum(increase(tetragon_events_total[5m])) / 300 > 1000
          for: 10m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "High Tetragon event rate"
            description: |
              Tetragon is processing more than 1000 events per second.
              This might indicate:
              - Security incident in progress
              - Misconfigured TracingPolicy
              - Normal high activity workload

              Current rate: {{ $value | humanize }} events/sec
              Event type: {{ $labels.type }}

        - alert: TetragonPolicyNotLoaded
          expr: |
            sum(tetragon_tracingpolicy_loaded{state="enabled"}) == 0
          for: 5m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Tetragon TracingPolicies not loaded"
            description: |
              No TracingPolicies are loaded in Tetragon.
              Security monitoring is ineffective without policies!

              Check:
              - TracingPolicy CRD status
              - Tetragon operator logs
              - Policy YAML syntax

        - alert: TetragonEventLoss
          expr: |
            sum(increase(tetragon_observer_ringbuf_events_lost_total[5m])) / 300 > 10
          for: 10m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Tetragon is losing events"
            description: |
              Tetragon ringbuf is losing events due to high load or backpressure.

              Loss rate: {{ $value | humanize }} events/sec
              Pod: {{ $labels.pod }}

              Security visibility may be compromised!
              Consider:
              - Increasing Tetragon resources
              - Reducing TracingPolicy scope
              - Checking export pipeline health

        - alert: TetragonQueueEventLoss
          expr: |
            sum(increase(tetragon_observer_ringbuf_queue_events_lost_total[5m])) / 300 > 5
          for: 5m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Tetragon queue losing events"
            description: |
              eBPF ring buffer queue is full - events are being missed!

              Missed rate: {{ $value | humanize }} events/sec
              Pod: {{ $labels.pod }}

              Possible causes:
              - Insufficient kernel ring buffer size
              - High system event rate
              - Tetragon agent CPU throttling

        - alert: TetragonProcessCacheFull
          expr: |
            tetragon_process_cache_size / tetragon_process_cache_capacity > 0.9
          for: 10m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Tetragon process cache near capacity"
            description: |
              Process cache is {{ $value | humanizePercentage }} full.

              Pod: {{ $labels.pod }}

              Consider increasing processCacheSize in HelmRelease.

        - alert: TetragonHighErrorRate
          expr: |
            sum(increase(tetragon_errors_total[5m])) / 300 > 1
          for: 10m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "High Tetragon error rate"
            description: |
              Tetragon is experiencing elevated error rates.

              Error rate: {{ $value | humanize }} errors/sec
              Error type: {{ $labels.type }}
              Pod: {{ $labels.pod }}

              Check Tetragon logs for details.

        - alert: TetragonMapErrors
          expr: |
            sum(increase(tetragon_map_errors_update_total[5m])) / 300 > 1 or
            sum(increase(tetragon_map_errors_delete_total[5m])) / 300 > 1
          for: 5m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Tetragon BPF map errors"
            description: |
              Tetragon is experiencing BPF map operation errors.

              Error rate: {{ $value | humanize }} errors/sec
              Map: {{ $labels.map }}
              Pod: {{ $labels.pod }}

              This may indicate kernel version incompatibility or resource limits.
