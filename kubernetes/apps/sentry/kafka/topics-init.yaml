---
apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topics-init
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "0"
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: kafka-topics-init
    spec:
      restartPolicy: OnFailure
      priorityClassName: cluster-low
      containers:
        - name: create-topics
          image: confluentinc/cp-kafka:7.6.6
          command:
            - sh
            - -c
            - |
              echo "Creating Kafka topics from sentry-kafka-schemas..."
              while read -r topic; do
                [ -z "$topic" ] && continue
                kafka-topics --bootstrap-server kafka.sentry.svc.cluster.local:9092 \
                  --create --topic "$topic" \
                  --partitions 1 --replication-factor 1 \
                  --if-not-exists 2>&1 | grep -v "already exists" || true
              done < /config/topics.txt
              echo "Done! Topics created."
              kafka-topics --bootstrap-server kafka.sentry.svc.cluster.local:9092 --list | wc -l
          volumeMounts:
            - name: topics
              mountPath: /config
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              memory: 256Mi
      volumes:
        - name: topics
          configMap:
            name: kafka-topics
