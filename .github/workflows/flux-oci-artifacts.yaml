---
name: Flux OCI Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'kubernetes/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write  # Required for Cosign keyless signing

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/flux-manifests

jobs:
  build-and-push:
    runs-on: oci-workflows-runner
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.6.0
        with:
          cosign-release: 'v2.2.4'

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push OCI artifact
        id: build
        run: |
          # Create temporary directory for flux manifests
          mkdir -p flux-manifests

          # Copy kubernetes directory to temporary location
          cp -r kubernetes/ flux-manifests/

          # Push main artifact first
          echo "Pushing main artifact..."
          flux push artifact oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --path="./flux-manifests" \
            --source="${{ github.repositoryUrl }}" \
            --revision="${{ github.sha }}"

          # Tag artifact as latest (if on main branch)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Tagging as latest..."
            flux tag artifact oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --tag latest

            # Also tag with branch name
            flux tag artifact oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --tag main
          fi

          # Sign the main artifact
          echo "Signing artifact..."
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

          # If on main branch, also sign the latest tag
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          fi

          # Get digest for the main artifact
          DIGEST=$(flux tag artifact oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --output json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

  update-flux-system:
    needs: build-and-push
    runs-on: oci-workflows-runner
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update flux-system to use OCI artifact
        run: |
          echo "Built OCI artifact: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Digest: ${{ needs.build-and-push.outputs.image-digest }}"

          # Send webhook to main receiver - Flux will automatically detect what changed
          echo "Sending webhook to Flux for immediate sync..."

          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "Authorization: token ${{ secrets.FLUX_WEBHOOK_TOKEN }}" \
            -d '{
              "ref": "refs/heads/main",
              "repository": {
                "name": "${{ github.event.repository.name }}",
                "full_name": "${{ github.repository }}"
              },
              "head_commit": {
                "id": "${{ github.sha }}",
                "message": "Update OCI artifacts",
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              }
            }' \
            https://flux-webhook.vzkn.eu/hook/github-webhook

          echo "Webhook sent! Flux will automatically reconcile only changed applications."
