---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: sensitive-files
spec:
  kprobes:
  - call: "security_file_open"
    syscall: false
    return: false
    args:
    - index: 0
      type: "file"
    selectors:
    - matchArgs:
      - index: 0
        operator: "Prefix"
        values:
        - "/etc/shadow"
        - "/etc/gshadow"
        - "/etc/passwd"
        - "/etc/sudoers"
        - "/etc/sudoers.d"
        - "/root/.ssh"
        - "/var/lib/kubelet"
        - "/etc/kubernetes"
        - "/etc/cni"
        - "/opt/cni"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: privileged-execution
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/bin/bash"
        - "/bin/sh"
        - "/usr/bin/bash"
        - "/usr/bin/sh"
        - "/bin/dash"
      matchCapabilities:
      - type: Effective
        operator: In
        values:
        - "CAP_SYS_ADMIN"
        - "CAP_SYS_PTRACE"
        - "CAP_SYS_MODULE"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: suspicious-network
spec:
  kprobes:
  - call: "tcp_connect"
    syscall: false
    return: false
    args:
    - index: 0
      type: "sock"
    selectors:
    - matchArgs:
      # Monitor connections to common C2/malware ports
      - index: 0
        operator: "DPort"
        values:
        - "4444"   # Metasploit
        - "5555"   # Android Debug Bridge / Malware
        - "6666"   # IRC bots
        - "31337"  # Elite/Back Orifice
        - "8080"   # Common proxy/C2
        - "9001"   # Tor
        - "1337"   # Common backdoor
        - "12345"  # NetBus
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: crypto-mining-detection
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    # Known crypto mining binaries
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "xmrig"
        - "minerd"
        - "ccminer"
        - "ethminer"
        - "claymore"
        - "cgminer"
        - "bfgminer"
        - "t-rex"
        - "phoenixminer"
        - "lolminer"
        - "nbminer"
      matchActions:
      - action: Post
    # Curl/wget piping to shell (common crypto miner installation)
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "curl"
        - "wget"
      matchBinaries:
      - operator: "In"
        values:
        - "/bin/bash"
        - "/bin/sh"
        - "/usr/bin/bash"
        - "/usr/bin/sh"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: ssh-activity
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/ssh"
        - "/usr/bin/scp"
        - "/usr/bin/sftp"
        - "/usr/sbin/sshd"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: package-management
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/apt"
        - "/usr/bin/apt-get"
        - "/usr/bin/dpkg"
        - "/usr/bin/yum"
        - "/usr/bin/dnf"
        - "/usr/bin/rpm"
        - "/usr/bin/apk"
        - "/usr/bin/pacman"
        - "/usr/local/bin/pip"
        - "/usr/bin/pip"
        - "/usr/bin/npm"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: container-escape-attempts
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    # nsenter - used to escape containers
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/nsenter"
        - "/bin/nsenter"
      matchActions:
      - action: Post
    # Docker socket access
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/docker"
        - "/usr/local/bin/docker"
      matchActions:
      - action: Post
    # crictl (container runtime CLI)
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/crictl"
        - "/usr/local/bin/crictl"
      matchActions:
      - action: Post
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cilium/tetragon/main/pkg/k8s/apis/cilium.io/client/crds/v1alpha1/cilium.io_tracingpolicies.yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: kubectl-exec
spec:
  kprobes:
  - call: "do_execve"
    syscall: false
    return: false
    args:
    - index: 0
      type: "string"
    selectors:
    - matchArgs:
      - index: 0
        operator: "In"
        values:
        - "/usr/bin/kubectl"
        - "/usr/local/bin/kubectl"
      matchActions:
      - action: Post
