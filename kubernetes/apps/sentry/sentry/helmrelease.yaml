---
# yaml-language-server: $schema=https://schemas.vzkn.eu/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: sentry
spec:
  interval: 1h
  url: https://sentry-kubernetes.github.io/charts
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sentry
spec:
  interval: 1h
  chart:
    spec:
      # renovate: registryUrl=https://sentry-kubernetes.github.io/charts
      chart: sentry
      version: 28.0.1
      sourceRef:
        kind: HelmRepository
        name: sentry
  values:
    # ============================================================================
    # Global Configuration
    # ============================================================================
    profiles:
      - feature-complete

    serviceAccount:
      enabled: true
      create: true
      name: sentry

    priorityClassName: cluster-low

    # ============================================================================
    # Bundled Services - All Disabled (using external)
    # ============================================================================
    postgresql:
      enabled: false
    redis:
      enabled: false
    clickhouse:
      enabled: false
    zookeeper:
      enabled: false
    rabbitmq:
      enabled: false
    kafka:
      enabled: false
    nginx:
      enabled: false
    ingress:
      enabled: false
    pgbouncer:
      enabled: false

    # ============================================================================
    # GeoIP (MaxMind GeoLite2)
    # ============================================================================
    # PVC created separately in pvc.yaml (Helm uses existing via lookupVolumeName)
    geodata:
      accountID: ${MAXMIND_ACCOUNT_ID}
      licenseKey: ${MAXMIND_LICENSE_KEY}
      editionIDs: GeoLite2-City
      volumeName: data-sentry-geoip
      mountPath: /geoip
      path: /geoip/GeoLite2-City.mmdb
      persistence:
        storageClass: ceph-block
        size: 1Gi
        accessModes:
          - ReadWriteOnce
        lookupVolumeName: true

    # ============================================================================
    # External Services
    # ============================================================================
    # PostgreSQL via CloudNative-PG with PgBouncer pooler
    externalPostgresql:
      host: pooler-sentry-rw.sentry.svc.cluster.local
      port: 5432
      username: sentry
      database: sentry
      existingSecret: postgres-sentry-app
      existingSecretKeys:
        password: password

    # Redis via Dragonfly
    externalRedis:
      host: sentry-dragonfly.sentry.svc.cluster.local
      port: 6379
      db: 0

    # ClickHouse (single node)
    externalClickhouse:
      host: clickhouse.sentry.svc.cluster.local
      tcpPort: 9000
      httpPort: 8123
      username: clickhouse
      database: default
      singleNode: true
      existingSecret: sentry-secret
      existingSecretKey: clickhouse-password

    # Kafka (Confluent KRaft, in sentry namespace)
    externalKafka:
      host: kafka.sentry.svc.cluster.local
      port: 9092

    # ============================================================================
    # Hooks & Initialization
    # ============================================================================
    # hooks:
    #   enabled: false
    #   dbCheck:
    #     enabled: true
    #   dbInit:
    #     enabled: false

    # ============================================================================
    # System & Auth Configuration
    # ============================================================================
    system:
      adminEmail: admin@sentry.vzkn.eu
      url: https://sentry.vzkn.eu
      public: false
      existingSecret: sentry-secret

    user:
      create: true
      email: admin@sentry.vzkn.eu
      existingSecret: sentry-secret
      existingSecretKey: ADMIN_PASSWORD

    auth:
      register: false

    # NOTE: Temporarily set to dummy to complete Welcome wizard (issue #1990) before setting up SMTP
    # After wizard completion, change back to smtp
    # mail:
    #   backend: dummy
    #   useTls: false
    #   useSsl: false
    #   username: ""
    #   password: ""
    #   # existingSecret: sentry-secret
    #   # existingSecretKey: mail-password
    #   port: 587
    #   host: ""
    #   from: ""
    mail:
      backend: smtp
      useTls: true
      useSsl: false
      username: "admin@vzkn.eu"
      password: ""
      existingSecret: sentry-secret
      existingSecretKey: mail-password
      port: 587
      host: "smtp.protonmail.ch"
      from: "admin@vzkn.eu"

    # ============================================================================
    # Application Configuration
    # ============================================================================
    config:
      sentryConfPy: |
        GEOIP_PATH_MMDB = '/geoip/GeoLite2-City.mmdb'
        CSRF_TRUSTED_ORIGINS = ["https://sentry.vzkn.eu"]
        USE_X_FORWARDED_HOST = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
        CSRF_COOKIE_SECURE = True
        SESSION_COOKIE_SECURE = True
        SOCIAL_AUTH_REDIRECT_IS_HTTPS = True
        SENTRY_BEACON = False
        # Exempt SDK API endpoints from CSRF (they don't have Referer headers)
        CSRF_TRUSTED_ORIGINS += ["null"]  # For SDK requests without origin
        # Disable internal monitoring completely (causes timeout loops)
        import sentry_sdk
        sentry_sdk.init(
            dsn=None,
            default_integrations=False,
            auto_session_tracking=False,
            traces_sample_rate=0,
            profiles_sample_rate=0,
            send_default_pii=False,
        )
      web:
        httpKeepalive: 15
        httpChunkedInput: true
        workers: 3
        memoryReport: false
        maxRequests: 100000
        maxRequestsDelta: 500
        maxWorkerLifetime: 86400
        thunderLock: true
        logXForwardedFor: false
        bufferSize: 32768
        limitPost: 209715200
        disableLogging: true
        reloadOnRss: 600
        ignoreSignpipe: true
        ignoreWriteErrors: true
        disableWriteException: true

    # Disable internal self-monitoring
    extraEnv:
      - name: SENTRY_DSN
        value: ""
      - name: SENTRY_ENVIRONMENT
        value: ""
      - name: SENTRY_RELEASE
        value: ""
      - name: SENTRY_TRACES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_PROFILES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_SEND_DEFAULT_PII
        value: "false"

    # ============================================================================
    # Storage (S3-compatible - Garage)
    # ============================================================================
    nodestore:
      backend: s3
      s3:
        bucketName: sentry
        bucketPath: nodestore
        endpointUrl: https://api.s3.vzkn.eu
        regionName: eu-central-1
        existingSecret: sentry-secret
        accessKeyIdRef: s3-access-key-id
        secretAccessKeyRef: s3-secret-access-key

    filestore:
      backend: s3
      s3:
        bucketName: sentry
        endpointUrl: https://api.s3.vzkn.eu
        region: eu-central-1
        existingSecret: sentry-secret
        accessKeyIDKey: s3-access-key-id
        secretAccessKeyKey: s3-secret-access-key

    # ============================================================================
    # Sentry Core Components
    # ============================================================================
    sentry:
      singleOrganization: true

      # Features control component auto-enablement
      features:
        orgSubdomains: false
        enableProfiling: false      # Auto-disables: vroom, ingestProfiles, profilesConsumer, profiling*Consumer
        enableSessionReplay: true   # Auto-enables: replaysConsumer, ingestReplayRecordings
        enableFeedback: true        # Auto-enables: ingestFeedback
        enableSpan: true            # Auto-enables: processSpans, processSegments
        enableUptime: false         # Auto-disables: uptimeChecker, uptimeResults

      # ------------------------------------------
      # Web & API
      # ------------------------------------------
      web:
        probeInitialDelaySeconds: 180
        probeFailureThreshold: 20
        probePeriodSeconds: 30
        probeTimeoutSeconds: 60

      # ------------------------------------------
      # Task System (replaces Celery)
      # ------------------------------------------
      taskWorker:
        concurrency: 4

      taskBroker:
        persistence:
          enabled: true
          size: 1Gi

      # ------------------------------------------
      # Cleanup
      # ------------------------------------------
      cleanup:
        days: 90

      # ------------------------------------------
      # Disabled Components (SaaS-only / unused)
      # ------------------------------------------
      billingMetricsConsumer:
        enabled: false
      genericMetricsConsumer:
        enabled: false
      subscriptionConsumerResultsEapItems:
        enabled: false
      subscriptionConsumerGenericMetrics:
        enabled: false
      subscriptionConsumerMetrics:
        enabled: false
      monitorsClockTasks:
        enabled: false
      monitorsClockTick:
        enabled: false

    # ============================================================================
    # Snuba (ClickHouse query layer)
    # ============================================================================
    snuba:
      # ------------------------------------------
      # Disabled Components (SaaS-only / unused)
      # ------------------------------------------
      eapItemsConsumer:
        enabled: false
      subscriptionConsumerEapItems:
        enabled: false
      outcomesBillingConsumer:
        enabled: false
      genericMetricsGaugesConsumer:
        enabled: false
      genericMetricsCountersConsumer:
        enabled: false
      genericMetricsDistributionConsumer:
        enabled: false
      genericMetricsSetsConsumer:
        enabled: false
      subscriptionConsumerGenericMetricsDistributions:
        enabled: false
      subscriptionConsumerGenericMetricsSets:
        enabled: false
      subscriptionConsumerGenericMetricsCounters:
        enabled: false
      subscriptionConsumerGenericMetricsGauges:
        enabled: false

    # ============================================================================
    # Symbolicator (Native crash symbolication)
    # ============================================================================
    symbolicator:
      api:
        persistence:
          enabled: false
