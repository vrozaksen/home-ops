---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: nextcloud-charts
  namespace: self-hosted
spec:
  interval: 2h
  url: https://nextcloud.github.io/helm/
  timeout: 3m
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app nextcloud
spec:
  interval: 1h
  chart:
    spec:
      chart: nextcloud
      version: 6.6.10
      sourceRef:
        kind: HelmRepository
        name: nextcloud-charts
        namespace: self-hosted
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      repository: public.ecr.aws/docker/library/nextcloud
      flavor: fpm-alpine
      # renovate: datasource=docker depName=nextcloud
      tag: 31.0.6-fpm-alpine
      pullPolicy: IfNotPresent
    deploymentAnnotations:
      reloader.stakater.com/auto: "true"
    replicaCount: 1
    phpClientHttpsFix:
      enabled: true
      protocol: https
    nextcloud:
      host: cloud.vzkn.eu
      existingSecret:
        enabled: true
        secretName: &secret nextcloud-secret
        usernameKey: NEXTCLOUD_ADMIN_USER
        passwordKey: NEXTCLOUD_ADMIN_PASS
        smtpUsernameKey: SMTP_USERNAME
        smtpPasswordKey: SMTP_PASSWORD
        smtpHostKey: SMTP_HOST
      update: 0
      containerPort: 8080
      trustedDomains:
        - sso.vzkn.eu
        - cloud.vzkn.eu
        - vzkn.eu
      mail:
        enabled: true
        fromAddress: admin
        domain: vzkn.eu
        smtp:
          secure: none
          port: 587
          authtype: LOGIN

      ## PHP Configuration files
      # Will be injected in /usr/local/etc/php/conf.d for apache image and in /usr/local/etc/php-fpm.d when nginx.enabled: true
      phpConfigs:
        custom.config.php: |
          <?php
            $CONFIG = array(
              "check_data_directory_permissions"=> false, # fix data directory permissions error
              "trusted_domains" => array (
                $_ENV["NEXTCLOUD_TRUSTED_DOMAINS"], # fix probes 400 error
              ),
            );
        uploadLimit.ini: |
          upload_max_filesize = 16G
          post_max_size = 16G
          max_input_time = 3600
          max_execution_time = 3600
      ## Default config files that utilize environment variables:
      # see: https://github.com/nextcloud/docker/tree/master#auto-configuration-via-environment-variables
      # IMPORTANT: Will be used only if you put extra configs, otherwise default will come from nextcloud itself
      # Default confgurations can be found here: https://github.com/nextcloud/docker/tree/master/.config
      defaultConfigs:
        .htaccess: true
        apache-pretty-urls.config.php: true
        apcu.config.php: true
        apps.config.php: true
        autoconfig.php: true
        redis.config.php: true
        reverse-proxy.config.php: false
        s3.config.php: false
        smtp.config.php: true
        swift.config.php: false
        upgrade-disable-web.config.php: true
        imaginary.config.php: false

      # Extra config files created in /var/www/html/config/
      # ref: https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/config_sample_php_parameters.html#multiple-config-php-file
      configs:
        fed-fixes.config.php: |-
          <?php
          $CONFIG = array (
            "davstorage.request_timeout" => 200,
          );
        logging.config.php: |-
          <?php
          $CONFIG = array (
            'log_type' => 'file',
            'logfile' => 'nextcloud.log',
            'loglevel' => 0,
            'logdateformat' => 'F d, Y H:i:s'
            );
        proxy.config.php: |-
          <?php
          $CONFIG = array (
            'trusted_proxies' => array(
              0 => '127.0.0.1',
              1 => '10.96.0.0/16',
            ),
            'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
          );
        ingress.config.php: |-
          <?php
          $CONFIG = array (
            'overwrite.cli.url' => 'https://cloud.vzkn.eu',
            'overwriteprotocol' => 'https',
            'allow_local_remote_servers' => true
          );
        misc.config.php: |-
          <?php
          $CONFIG = array (
            'default_timezone' => 'Europe/Warsaw',
            'default_phone_region' => 'PL',
            'maintenance_window_start' => 1,
          );
        s3.config.php: |-
          <?php
          $CONFIG = array (
            'objectstore' => array(
              'class' => '\\OC\\Files\\ObjectStore\\S3',
              'arguments' => array(
                'hostname'       => 's3.vzkn.eu',
                'port'           => 443,
                'use_path_style' => true,
                'bucket'         => 'nextcloud',
                'region'         => 'main',
                'autocreate'     => false,
                'key'            => getenv('S3_ACCESS_KEY'),
                'secret'         => getenv('S3_SECRET_KEY'),
                'use_ssl'        => true,
              ),
            ),
          );
        sso.config.php: |-
          <?php
          $CONFIG = array (
            'allow_user_to_change_display_name' => false,
            'lost_password_link' => 'disabled',
            'oidc_login_provider_url' => 'https://sso.vzkn.eu/application/o/nextcloud/',
            'oidc_login_client_id' => getenv('NEXTCLOUD_OAUTH_CLIENT_ID'),
            'oidc_login_client_secret' => getenv('NEXTCLOUD_OAUTH_CLIENT_SECRET'),
            'oidc_login_auto_redirect' => true,
            'oidc_login_logout_url' => 'https://sso.vzkn.eu/application/o/nextcloud/end-session/',
            'oidc_login_end_session_redirect' => true,
            'oidc_login_default_quota' => '5000000000',
            'oidc_login_button_text' => 'Authentik SSO',
            'oidc_login_hide_password_form' => true,
            'oidc_login_attributes' => array (
                     'id' => 'sub',
                     'name' => 'name',
                     'mail' => 'email',
            ),
            'oidc_create_groups' => true,
            'oidc_login_code_challenge_method' => 'S256',
            'oidc_login_webdav_enabled' => true,
            'oidc_login_disable_registration' => false,
          );
        previews.config.php: |-
          <?php
          $CONFIG = array (
            'enable_previews' => true,
            'enabledPreviewProviders' => array (
              'OC\Preview\Movie',
              'OC\Preview\PNG',
              'OC\Preview\JPEG',
              'OC\Preview\GIF',
              'OC\Preview\BMP',
              'OC\Preview\XBitmap',
              'OC\Preview\MP3',
              'OC\Preview\MP4',
              'OC\Preview\TXT',
              'OC\Preview\MarkDown',
              'OC\Preview\PDF'
            ),
          );

      extraEnv:
        - name: REDIS_HOST
          value: nextcloud-dragonfly.self-hosted.svc.cluster.local.
        - name: REDIS_HOST_PORT
          value: "6379"
        - name: NEXTCLOUD_OAUTH_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: *secret
              key: NEXTCLOUD_OAUTH_CLIENT_SECRET
        - name: NEXTCLOUD_OAUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: *secret
              key: NEXTCLOUD_OAUTH_CLIENT_ID
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: *secret
              key: S3_ACCESS_KEY
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: *secret
              key: S3_SECRET_KEY

      securityContext:
        runAsUser: 1000
        runAsGroup: 100
        runAsNonRoot: true
        readOnlyRootFilesystem: false

      podSecurityContext:
        runAsUser: 1000
        runAsGroup: 100
        runAsNonRoot: true
        readOnlyRootFilesystem: false

      extraVolumes:
        - name: nginx-cache
          mountPath: "/var/cache/nginx" # fix permission denied error

    nginx:
      enabled: true
      image:
        repository: nginxinc/nginx-unprivileged
        tag: 1.27.4@sha256:7a76302625f26fd9ea82da99c0e14c5f4def3a839b21e4138acdcbefc790219f
      containerPort: 8080
      config:
        default: false

        custom: |-
          upstream php-handler {
              server 127.0.0.1:9000;
          }

          server {
              # Default, IPv4 only
              listen 8080;

              # HSTS settings
              # WARNING: Only add the preload option once you read about
              # the consequences in https://hstspreload.org/. This option
              # will add the domain to a hardcoded list that is shipped
              # in all major browsers and getting removed from this list
              # could take several months.
              add_header Referrer-Policy "no-referrer" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-Download-Options "noopen" always;
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Permitted-Cross-Domain-Policies "none" always;
              add_header X-Robots-Tag "noindex, nofollow" always;
              add_header X-XSS-Protection "1; mode=block" always;

              # set max upload size
              client_max_body_size 16G;
              fastcgi_buffers 64 4K;

              # Enable gzip but do not remove ETag headers
              gzip on;
              gzip_vary on;
              gzip_comp_level 4;
              gzip_min_length 256;
              gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
              gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

              # Pagespeed is not supported by Nextcloud, so if your server is built
              # with the `ngx_pagespeed` module, uncomment this line to disable it.
              #pagespeed off;

              # Remove X-Powered-By, which is an information leak
              fastcgi_hide_header X-Powered-By;

              # Add .mjs as a file extension for javascript
              # Either include it in the default mime.types list
              # or include you can include that list explicitly and add the file extension
              # only for Nextcloud like below:
              include mime.types;
              types {
                  text/javascript js mjs;
              }

              # Path to the root of your installation
              root /var/www/html;

              # Specify how to handle directories -- specifying `/index.php$request_uri`
              # here as the fallback means that Nginx always exhibits the desired behaviour
              # when a client requests a path that corresponds to a directory that exists
              # on the server. In particular, if that directory contains an index.php file,
              # that file is correctly served; if it doesn't, then the request is passed to
              # the front-end controller. This consistent behaviour means that we don't need
              # to specify custom rules for certain paths (e.g. images and other assets,
              # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus
              # `try_files $uri $uri/ /index.php$request_uri`
              # always provides the desired behaviour.
              index index.php index.html /index.php$request_uri;

              # Rule borrowed from `.htaccess` to handle Microsoft DAV clients
              location = / {
                  if ( $http_user_agent ~ ^DavClnt ) {
                      return 302 /remote.php/webdav/$is_args$args;
                  }
              }

              location = /robots.txt {
                  allow all;
                  log_not_found off;
                  access_log off;
              }

              # Make a regex exception for `/.well-known` so that clients can still
              # access it despite the existence of the regex rule
              # `location ~ /(\.|autotest|...)` which would otherwise handle requests
              # for `/.well-known`.
              location ^~ /.well-known {
                  # The following 6 rules are borrowed from `.htaccess`

                  location = /.well-known/carddav     { return 301 /remote.php/dav/; }
                  location = /.well-known/caldav      { return 301 /remote.php/dav/; }
                  # Anything else is dynamically handled by Nextcloud
                  location ^~ /.well-known            { return 301 /index.php$uri; }

                  try_files $uri $uri/ =404;
              }

              # Rules borrowed from `.htaccess` to hide certain paths from clients
              location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)  { return 404; }
              location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console)              { return 404; }

              # Ensure this block, which passes PHP files to the PHP process, is above the blocks
              # which handle static assets (as seen below). If this block is not declared first,
              # then Nginx will encounter an infinite rewriting loop when it prepends `/index.php`
              # to the URI, resulting in a HTTP 500 error response.
              location ~ \.php(?:$|/) {
                  # Required for legacy support
                  rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode(_arm64)?\/proxy) /index.php$request_uri;

                  fastcgi_split_path_info ^(.+?\.php)(/.*)$;
                  set $path_info $fastcgi_path_info;

                  try_files $fastcgi_script_name =404;

                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                  fastcgi_param PATH_INFO $path_info;
                  #fastcgi_param HTTPS on;

                  fastcgi_param modHeadersAvailable true;         # Avoid sending the security headers twice
                  fastcgi_param front_controller_active true;     # Enable pretty urls
                  fastcgi_pass php-handler;

                  fastcgi_intercept_errors on;
                  fastcgi_request_buffering off;
                  fastcgi_read_timeout 200s;
                  fastcgi_send_timeout 200s;

              }

              location ~ \.(?:css|js|svg|gif)$ {
                  try_files $uri /index.php$request_uri;
                  expires 6M;         # Cache-Control policy borrowed from `.htaccess`
                  access_log off;     # Optional: Don't log access to assets
              }

              location ~ \.woff2?$ {
                  try_files $uri /index.php$request_uri;
                  expires 7d;         # Cache-Control policy borrowed from `.htaccess`
                  access_log off;     # Optional: Don't log access to assets
              }

              location / {
                  try_files $uri $uri/ /index.php$request_uri;
              }
          }

    externalDatabase:
      enabled: true
      type: postgresql
      existingSecret:
        enabled: true
        secretName: nextcloud-pguser-nextcloud
        usernameKey: user
        passwordKey: password
        hostKey: pgbouncer-host
        databaseKey: dbname

    ##
    ## Collabora chart configuration
    ## for more options see https://github.com/CollaboraOnline/online/tree/master/kubernetes/helm/collabora-online
    ##
    collabora:
      enabled: false

      autoscaling:
        # enable autocaling, please check collabora README.md first
        enabled: false

      collabora:
        ## HTTPS nextcloud domain, if needed
        aliasgroups: []
        #   - host: "https://nextcloud.domain:443"

        # set extra parameters for collabora
        # you may need to add --o:ssl.termination=true
        extra_params: --o:ssl.enable=false

        ## Specify server_name when the hostname is not reachable directly for
        # example behind reverse-proxy. example: collabora.domain
        server_name: null

        existingSecret:
          # set to true to to get collabora admin credentials from an existin secret
          # if set, ignores collabora.collabora.username and password
          enabled: false
          # name of existing Kubernetes Secret with collboara admin credentials
          secretName: ""
          usernameKey: "username"
          passwordKey: "password"

        # setup admin login credentials, these are ignored if
        # collabora.collabora.existingSecret.enabled=true
        password: examplepass
        username: admin

      # setup ingress
      ingress:
        # enable ingress for collabora online
        enabled: false
        className: ""
        # please check collabora values.yaml for nginx/haproxy annotations examples
        annotations: {}
        hosts:
          - host: chart-example.local
            paths:
            - path: /
              pathType: ImplementationSpecific
        tls: []
        #  - secretName: collabora-ingress-tls
        #    hosts:
        #      - collabora.domain

      # see collabora helm README.md for recommended values
      resources: {}

    service:
      type: ClusterIP
      port: 8080
      loadBalancerIP: ""
      nodePort:
      # -- use additional annotation on service for nextcloud
      annotations: {}

    persistence:
      enabled: true
      existingClaim: *app
      nextcloudData:
        enabled: true
        subPath: data
        existingClaim: nextcloud-data

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 4
        memory: 8Gi


    lifecycle:
      postStartCommand:
      - su
      - www-data
      - -s
      - /bin/sh
      - -c
      - >-
        cd /var/www/html;
        ./occ upgrade;
        ./occ db:add-missing-indices;
        /bin/true

    startupProbe:
      enabled: true
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 10
      successThreshold: 1

    cronjob:
      enabled: true
      # securityContext:
      #   runAsGroup: 100

    imaginary:
      enabled: false
      replicaCount: 1
      image:
        registry: docker.io
        repository: h2non/imaginary
        tag: 1.2.4@sha256:7facb4221047a5e79b9e902f380247f4e5bf4376400d0badbeb738d3e1c2f654
        pullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 10m
          memory: 1Gi
      securityContext:
        runAsUser: 1000
        runAsGroup: 100
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        capabilities: { drop: ["ALL"] }

    internalDatabase:
      enabled: false
    redis:
      enabled: false
    ingress:
      enabled: false
    metrics:
      enabled: false
    rbac:
      enabled: false
