---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: krr
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      krr:
        type: cronjob
        cronjob:
          schedule: "0 8 * * 1" # Every Monday at 8:00 AM
          backoffLimit: 1
          concurrencyPolicy: Forbid
          successfulJobsHistory: 3
          failedJobsHistory: 3
          ttlSecondsAfterFinished: 604800 # 7 days
        containers:
          app:
            image:
              repository: us-central1-docker.pkg.dev/genuine-flight-317411/devel/krr
              tag: v1.28.0
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e
                TIMESTAMP=$(date +%Y-%m-%d)
                echo "Starting KRR scan..."

                # Run KRR and generate HTML report
                python /app/krr.py simple \
                  --prometheus-url "${PROMETHEUS_URL}" \
                  --max-workers 3 \
                  -f html \
                  --logtostderr \
                  > /tmp/krr-report.html 2>/tmp/krr.log || true

                # Check if report was generated
                if [ ! -s /tmp/krr-report.html ]; then
                  echo "KRR scan failed or produced no output"
                  cat /tmp/krr.log
                  exit 1
                fi

                echo "Report generated, uploading to Nextcloud..."

                # Upload to Nextcloud via WebDAV
                REPORT_PATH="${NEXTCLOUD_FOLDER}/krr-report-${TIMESTAMP}.html"
                curl -sf -X PUT \
                  -u "${NEXTCLOUD_USER}:${NEXTCLOUD_PASSWORD}" \
                  -H "Content-Type: text/html" \
                  --data-binary @/tmp/krr-report.html \
                  "${NEXTCLOUD_URL}/remote.php/dav/files/${NEXTCLOUD_USER}/${REPORT_PATH}" \
                  && echo "Report uploaded to Nextcloud: ${REPORT_PATH}" \
                  || echo "Nextcloud upload failed"

                echo ""
                echo "Done! Full report: https://${NEXTCLOUD_URL#https://}/${REPORT_PATH}"
            env:
              TZ: Europe/Warsaw
              PROMETHEUS_URL: http://prometheus-operated.observability.svc.cluster.local:9090
              NEXTCLOUD_URL: https://cloud.vzkn.eu
              NEXTCLOUD_FOLDER: Reports/KRR
            envFrom:
              - secretRef:
                  name: krr-secret
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false # KRR needs to write temp files
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 50m
                memory: 512Mi
              limits:
                memory: 2Gi
        pod:
          restartPolicy: Never
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 100
    rbac:
      roles:
        krr:
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["pods", "nodes", "namespaces", "services"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["apps"]
              resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["batch"]
              resources: ["jobs", "cronjobs"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["autoscaling"]
              resources: ["horizontalpodautoscalers"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["autoscaling.k8s.io"]
              resources: ["verticalpodautoscalers"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["argoproj.io"]
              resources: ["rollouts"]
              verbs: ["get", "list", "watch"]
      bindings:
        krr:
          type: ClusterRoleBinding
          roleRef:
            identifier: krr
          subjects:
            - identifier: krr
    serviceAccount:
      krr: {}
