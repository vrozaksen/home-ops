---
# yaml-language-server: $schema=https://schemas.vzkn.eu/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: sentry
spec:
  interval: 1h
  url: https://sentry-kubernetes.github.io/charts
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sentry
spec:
  interval: 1h
  chart:
    spec:
      # renovate: registryUrl=https://sentry-kubernetes.github.io/charts
      chart: sentry
      version: 28.0.0
      sourceRef:
        kind: HelmRepository
        name: sentry
  values:
    # Deployment profile
    profiles:
      - feature-complete

    # Service Account
    serviceAccount:
      enabled: true
      create: true
      name: sentry

    # Low priority - can be preempted by critical workloads
    priorityClassName: cluster-low

    # Disable hooks after successful initial deployment
    hooks:
      enabled: false
      dbCheck:
        enabled: true
      dbInit:
        enabled: false

    # Disable bundled services (using external)
    postgresql:
      enabled: false
    redis:
      enabled: false
    clickhouse:
      enabled: false
    zookeeper:
      enabled: false
    rabbitmq:
      enabled: false
    kafka:
      enabled: false
    nginx:
      enabled: false

    # External PostgreSQL (CNPG)
    externalPostgresql:
      host: pooler-sentry-rw.sentry.svc.cluster.local
      port: 5432
      username: sentry
      database: sentry
      existingSecret: postgres-sentry-app
      existingSecretKeys:
        password: password

    # External Redis (Dragonfly)
    externalRedis:
      host: sentry-dragonfly.sentry.svc.cluster.local
      port: 6379
      db: 0

    # External ClickHouse
    externalClickhouse:
      host: clickhouse.database.svc.cluster.local
      tcpPort: 9000
      httpPort: 8123
      username: clickhouse
      database: default
      singleNode: true
      existingSecret: sentry-secret
      existingSecretKey: clickhouse-password

    # External Kafka (Strimzi)
    externalKafka:
      host: sentry-kafka-kafka-bootstrap.sentry.svc.cluster.local
      port: 9092

    # Disable internal monitoring completely
    extraEnv:
      - name: SENTRY_DSN
        value: ""
      - name: SENTRY_ENVIRONMENT
        value: ""
      - name: SENTRY_RELEASE
        value: ""
      - name: SENTRY_TRACES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_PROFILES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_SEND_DEFAULT_PII
        value: "false"

    # System configuration
    system:
      adminEmail: admin@sentry.vzkn.eu
      url: https://sentry.vzkn.eu
      public: false
      existingSecret: sentry-secret

    # Mail configuration
    # NOTE: Temporarily set to dummy to complete Welcome wizard (issue #1990) before setting up SMTP
    # After wizard completion, change back to smtp
    # mail:
    #   backend: dummy
    #   useTls: false
    #   useSsl: false
    #   username: ""
    #   password: ""
    #   # existingSecret: sentry-secret
    #   # existingSecretKey: mail-password
    #   port: 587
    #   host: ""
    #   from: ""
    mail:
      backend: smtp
      useTls: true
      useSsl: false
      username: "admin@vzkn.eu"
      password: ""
      existingSecret: sentry-secret
      existingSecretKey: mail-password
      port: 587
      host: "smtp.protonmail.ch"
      from: "admin@vzkn.eu"


    # Admin user
    user:
      create: true
      email: admin@sentry.vzkn.eu
      existingSecret: sentry-secret
      existingSecretKey: ADMIN_PASSWORD

    # Auth
    auth:
      register: false

    # Python/Django configuration
    config:
      sentryConfPy: |
        CSRF_TRUSTED_ORIGINS = ["https://sentry.vzkn.eu"]
        USE_X_FORWARDED_HOST = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
        CSRF_COOKIE_SECURE = True
        SESSION_COOKIE_SECURE = True
        SOCIAL_AUTH_REDIRECT_IS_HTTPS = True
        SENTRY_BEACON = False
        # Exempt SDK API endpoints from CSRF (they don't have Referer headers)
        CSRF_TRUSTED_ORIGINS += ["null"]  # For SDK requests without origin
        # Disable internal monitoring completely (causes timeout loops)
        import sentry_sdk
        sentry_sdk.init(
            dsn=None,
            default_integrations=False,
            auto_session_tracking=False,
            traces_sample_rate=0,
            profiles_sample_rate=0,
            send_default_pii=False,
        )
      web:
        httpKeepalive: 15
        httpChunkedInput: true
        workers: 3
        memoryReport: false
        maxRequests: 100000
        maxRequestsDelta: 500
        maxWorkerLifetime: 86400
        thunderLock: true
        logXForwardedFor: false
        bufferSize: 32768
        limitPost: 209715200
        disableLogging: true
        reloadOnRss: 600
        ignoreSignpipe: true
        ignoreWriteErrors: true
        disableWriteException: true

    # ==========================================
    # Sentry Components
    # ==========================================
    sentry:
      singleOrganization: true

      features:
        orgSubdomains: false
        enableProfiling: false
        enableSessionReplay: true
        enableFeedback: true
        enableSpan: true
        enableUptime: false

      # Core components
      taskScheduler:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      web:
        replicas: 1
        probeInitialDelaySeconds: 120
        probeFailureThreshold: 15
        probePeriodSeconds: 30
        probeTimeoutSeconds: 60
        resources:
          requests:
            cpu: 50m
            memory: 1Gi
          limits:
            memory: 4Gi

      worker:
        replicas: 1
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 4Gi

      cron:
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi

      taskBroker:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi
        persistence:
          enabled: true
          size: 1Gi

      taskWorker:
        enabled: true
        replicas: 1
        concurrency: 4
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 4Gi

      cleanup:
        enabled: true
        days: 90
        resources:
          requests:
            cpu: 25m
            memory: 256Mi
          limits:
            memory: 2Gi

      # Ingest consumers
      ingestConsumerEvents:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 512Mi
          limits:
            memory: 2Gi

      ingestConsumerTransactions:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 512Mi
          limits:
            memory: 2Gi

      ingestConsumerAttachments:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      ingestMonitors:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 1Gi

      ingestReplayRecordings:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      ingestOccurrences:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      ingestFeedback:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # Processing
      processSpans:
        replicas: 1
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 2Gi

      processSegments:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      genericMetricsConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      # Post-process forwarders (alerts)
      postProcessForwardErrors:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      postProcessForwardTransactions:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      postProcessForwardIssuePlatform:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # Subscription consumers (alerts)
      subscriptionConsumerEvents:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      subscriptionConsumerTransactions:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # ------------------------------------------
      # Disabled sentry components
      # ------------------------------------------
      uptimeResults:
        enabled: false
      billingMetricsConsumer:
        enabled: false
      ingestProfiles:
        enabled: false
      metricsConsumer:
        enabled: false
      subscriptionConsumerResultsEapItems:
        enabled: false
      subscriptionConsumerGenericMetrics:
        enabled: false
      subscriptionConsumerMetrics:
        enabled: false

    # ==========================================
    # Relay
    # ==========================================
    relay:
      replicas: 1
      resources:
        requests:
          cpu: 25m
          memory: 64Mi
        limits:
          memory: 256Mi

    # ==========================================
    # Snuba Components
    # ==========================================
    snuba:
      api:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      consumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      transactionsConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      metricsConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      replaysConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      outcomesConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      replacer:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      issueOccurrenceConsumer:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      groupAttributesConsumer:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # ------------------------------------------
      # Disabled snuba components
      # ------------------------------------------
      # Profiling (enableProfiling: false)
      profilesConsumer:
        enabled: false
      profilingProfilesConsumer:
        enabled: false
      profilingFunctionsConsumer:
        enabled: false
      profilingChunksConsumer:
        enabled: false

      # EAP (experimental)
      eapItemsConsumer:
        enabled: false
      subscriptionConsumerEapItems:
        enabled: false

      # Billing (internal Sentry SaaS)
      outcomesBillingConsumer:
        enabled: false

      # Generic metrics (not using custom SDK metrics)
      genericMetricsGaugesConsumer:
        enabled: false
      genericMetricsCountersConsumer:
        enabled: false
      genericMetricsDistributionConsumer:
        enabled: false
      genericMetricsSetsConsumer:
        enabled: false
      subscriptionConsumerGenericMetricsDistributions:
        enabled: false
      subscriptionConsumerGenericMetricsSets:
        enabled: false
      subscriptionConsumerGenericMetricsCounters:
        enabled: false
      subscriptionConsumerGenericMetricsGauges:
        enabled: false

    # ==========================================
    # Other Components
    # ==========================================
    symbolicator:
      enabled: true
      api:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi
        persistence:
          enabled: false

    sourcemaps:
      enabled: true

    vroom:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 25m
          memory: 64Mi
        limits:
          memory: 256Mi
      persistence:
        enabled: false

    # ==========================================
    # Storage (S3)
    # ==========================================
    nodestore:
      backend: s3
      s3:
        bucketName: sentry
        bucketPath: nodestore
        endpointUrl: https://api.s3.vzkn.eu
        regionName: eu-central-1
        existingSecret: sentry-secret
        accessKeyIdRef: s3-access-key-id
        secretAccessKeyRef: s3-secret-access-key

    filestore:
      backend: s3
      s3:
        bucketName: sentry
        endpointUrl: https://api.s3.vzkn.eu
        region: eu-central-1
        existingSecret: sentry-secret
        accessKeyIDKey: s3-access-key-id
        secretAccessKeyKey: s3-secret-access-key
      profiles:
        backend: s3
        s3:
          bucketName: sentry
          bucketPath: profiles
          endpointUrl: https://api.s3.vzkn.eu
          regionName: eu-central-1
          existingSecret: sentry-secret
          accessKeyIdRef: s3-access-key-id
          secretAccessKeyRef: s3-secret-access-key
