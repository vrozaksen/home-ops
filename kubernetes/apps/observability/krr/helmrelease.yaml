---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: krr
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      krr:
        type: cronjob
        cronjob:
          schedule: "0 8 * * 1"  # Every Monday at 8:00 AM
          backoffLimit: 1
          concurrencyPolicy: Forbid
          successfulJobsHistory: 3
          failedJobsHistory: 3
          ttlSecondsAfterFinished: 604800  # 7 days
        containers:
          app:
            image:
              repository: us-central1-docker.pkg.dev/genuine-flight-317411/devel/krr
              tag: v1.28.0
            command:
              - "/bin/sh"
              - "-c"
            args:
              - |
                set -e
                TIMESTAMP=$(date +%Y-%m-%d)
                echo "Starting KRR scan..."

                # Run KRR and generate CSV report
                python /app/krr.py simple \
                  --prometheus-url "${PROMETHEUS_URL}" \
                  --max-workers 3 \
                  -f csv \
                  --logtostderr \
                  > /tmp/krr-report.csv 2>/tmp/krr.log || true

                # Check if report was generated
                if [ ! -s /tmp/krr-report.csv ]; then
                  echo "KRR scan failed or produced no output"
                  cat /tmp/krr.log
                  exit 1
                fi

                echo "Report generated, uploading to Nextcloud..."

                # Upload to Nextcloud via WebDAV using Python requests
                python3 << 'UPLOAD_SCRIPT'
                import os
                import requests
                from datetime import date

                timestamp = date.today().strftime('%Y-%m-%d')
                nextcloud_url = os.environ['NEXTCLOUD_URL']
                nextcloud_user = os.environ['NEXTCLOUD_USER']
                nextcloud_password = os.environ['NEXTCLOUD_PASSWORD']
                nextcloud_folder = os.environ['NEXTCLOUD_FOLDER']
                auth = (nextcloud_user, nextcloud_password)
                base_url = f"{nextcloud_url}/remote.php/dav/files/{nextcloud_user}"

                # Ensure folder exists (create nested folders if needed)
                path_parts = []
                for folder in nextcloud_folder.split('/'):
                    if folder:
                        path_parts.append(folder)
                        folder_path = '/'.join(path_parts)
                        requests.request('MKCOL', f"{base_url}/{folder_path}", auth=auth)

                # Read file content for proper Content-Length
                with open('/tmp/krr-report.csv', 'rb') as f:
                    content = f.read()

                report_path = f"{nextcloud_folder}/krr-report-{timestamp}.csv"
                upload_url = f"{base_url}/{report_path}"

                response = requests.put(
                    upload_url,
                    data=content,
                    auth=auth,
                    headers={
                        'Content-Type': 'text/csv',
                        'Content-Length': str(len(content))
                    }
                )

                if response.status_code in (200, 201, 204):
                    print(f"Report uploaded to Nextcloud: {report_path}")
                else:
                    print(f"Nextcloud upload failed: {response.status_code} - {response.text}")
                    exit(1)
                UPLOAD_SCRIPT

                echo ""
                echo "Done!"
            env:
              TZ: Europe/Warsaw
              PROMETHEUS_URL: http://prometheus-operated.observability.svc.cluster.local:9090
              NEXTCLOUD_URL: https://cloud.vzkn.eu
              NEXTCLOUD_FOLDER: Reports/KRR
            envFrom:
              - secretRef:
                  name: krr-secret
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false  # KRR needs to write temp files
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 90m
                memory: 352Mi
              limits:
                memory: 704Mi
        pod:
          restartPolicy: Never
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 100
    rbac:
      roles:
        krr:
          type: ClusterRole
          rules:
            - apiGroups:
                - ""
              resources:
                - "pods"
                - "nodes"
                - "namespaces"
                - "services"
              verbs:
                - "get"
                - "list"
                - "watch"
            - apiGroups:
                - "apps"
              resources:
                - "deployments"
                - "daemonsets"
                - "statefulsets"
                - "replicasets"
              verbs:
                - "get"
                - "list"
                - "watch"
            - apiGroups:
                - "batch"
              resources:
                - "jobs"
                - "cronjobs"
              verbs:
                - "get"
                - "list"
                - "watch"
            - apiGroups:
                - "autoscaling"
              resources:
                - "horizontalpodautoscalers"
              verbs:
                - "get"
                - "list"
                - "watch"
            - apiGroups:
                - "autoscaling.k8s.io"
              resources:
                - "verticalpodautoscalers"
              verbs:
                - "get"
                - "list"
                - "watch"
            - apiGroups:
                - "argoproj.io"
              resources:
                - "rollouts"
              verbs:
                - "get"
                - "list"
                - "watch"
      bindings:
        krr:
          type: ClusterRoleBinding
          roleRef:
            identifier: krr
          subjects:
            - identifier: krr
    serviceAccount:
      krr: {}
