# ðŸ”’ Kubesec Security Scanner
# Automated security analysis for Kubernetes manifests
# This workflow uses actions that are not certified by GitHub.

name: ðŸ”’ Kubesec Security Analysis

on:
  push:
    branches: [ "main" ]
    paths:
      - "kubernetes/**/*.yaml"
      - "kubernetes/**/*.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "kubernetes/**/*.yaml"
      - "kubernetes/**/*.yml"
  schedule:
    - cron: '26 23 * * 1'
  workflow_dispatch:

env:
  KUBESEC_VERSION: "2.14.0"

jobs:
  security-scan:
    name: ðŸ›¡ï¸ Kubernetes Security Scan
    runs-on: home-ops-runner
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Discover Kubernetes Manifests
        id: discover
        run: |
          echo "ðŸ” Discovering Kubernetes manifests..."

          # Find all relevant YAML files, excluding certain patterns
          find kubernetes/ \
            \( -name "*.yaml" -o -name "*.yml" \) \
            ! -name "kustomization.yaml" \
            ! -name "kustomization.yml" \
            ! -path "*/flux-system/*" \
            ! -path "*/kube-system/*" \
            > manifests.txt

          MANIFEST_COUNT=$(wc -l < manifests.txt)

          echo "ðŸ“Š Found $MANIFEST_COUNT Kubernetes manifests to scan:"
          echo "manifest_count=$MANIFEST_COUNT" >> $GITHUB_OUTPUT

          if [ $MANIFEST_COUNT -eq 0 ]; then
            echo "âš ï¸ No manifests found to scan!"
            echo "scan_needed=false" >> $GITHUB_OUTPUT
          else
            echo "scan_needed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Manifest list:"
            cat manifests.txt | head -10
            if [ $MANIFEST_COUNT -gt 10 ]; then
              echo "... and $(($MANIFEST_COUNT - 10)) more files"
            fi
          fi

      - name: ðŸ”’ Run Kubesec Security Scanner
        if: steps.discover.outputs.scan_needed == 'true'
        uses: controlplaneio/kubesec-action@43d0ddff5ffee89a6bb9f29b64cd865411137b14
        with:
          input: kubernetes/
          format: template
          template: template/sarif.tpl
          output: kubesec-results.sarif
          exit-code: "0"

      - name: ðŸ“Š Generate Scan Summary
        if: steps.discover.outputs.scan_needed == 'true'
        run: |
          echo "## ðŸ”’ Kubesec Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Scanned**: ${{ steps.discover.outputs.manifest_count }} Kubernetes manifests" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f kubesec-results.sarif ]; then
            echo "âœ… **Status**: Scan completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Results**: Available in Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Scan failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload Security Results
        if: steps.discover.outputs.scan_needed == 'true' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: kubesec-results.sarif
          category: kubesec

      - name: âš ï¸ Skip Notification
        if: steps.discover.outputs.scan_needed == 'false'
        run: |
          echo "## ðŸ”’ Kubesec Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **No Kubernetes manifests found to scan**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The scan was skipped because no relevant YAML files were detected." >> $GITHUB_STEP_SUMMARY
