---
# yaml-language-server: $schema=https://schemas.vzkn.eu/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: sentry
spec:
  interval: 1h
  url: https://sentry-kubernetes.github.io/charts
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sentry
spec:
  interval: 1h
  chart:
    spec:
      # renovate: registryUrl=https://sentry-kubernetes.github.io/charts
      chart: sentry
      version: 28.0.0
      sourceRef:
        kind: HelmRepository
        name: sentry
  values:
    # Service Account
    serviceAccount:
      enabled: true
      create: true
      name: sentry

    # Disable hooks after successful initial deployment
    hooks:
      enabled: false
      dbCheck:
        enabled: true
      dbInit:
        enabled: false

    # Disable bundled services
    postgresql:
      enabled: false
    redis:
      enabled: false
    clickhouse:
      enabled: false
    zookeeper:
      enabled: false
    rabbitmq:
      enabled: false
    kafka:
      enabled: false
    nginx:
      enabled: true

    # External PostgreSQL (CNPG)
    externalPostgresql:
      host: pooler-sentry-rw.sentry.svc.cluster.local
      port: 5432
      username: sentry
      database: sentry
      existingSecret: postgres-sentry-app
      existingSecretKeys:
        password: password

    # External Redis (Dragonfly)
    externalRedis:
      host: sentry-dragonfly.sentry.svc.cluster.local
      port: 6379
      db: 0

    # External ClickHouse
    externalClickhouse:
      host: clickhouse.database.svc.cluster.local
      tcpPort: 9000
      httpPort: 8123
      username: clickhouse
      database: default
      singleNode: true
      existingSecret: sentry-secret
      existingSecretKey: clickhouse-password

    # External Kafka (Strimzi)
    externalKafka:
      host: sentry-kafka-kafka-bootstrap.sentry.svc.cluster.local
      port: 9092

    # System configuration
    system:
      adminEmail: admin@sentry.vzkn.eu
      url: https://sentry.vzkn.eu
      public: false
      existingSecret: sentry-secret

    # Mail configuration
    mail:
      backend: smtp
      useTls: true
      useSsl: false
      username: "admin@vzkn.eu"
      password: ""
      existingSecret: sentry-secret
      existingSecretKey: mail-password
      port: 587
      host: "smtp.protonmail.ch"
      from: "admin@vzkn.eu"

    # Admin user
    user:
      create: true
      email: admin@sentry.vzkn.eu
      existingSecret: sentry-secret
      existingSecretKey: ADMIN_PASSWORD

    # Auth
    auth:
      register: false

    # Python/Django configuration for proxy support
    config:
      sentryConfPy: |
        CSRF_TRUSTED_ORIGINS = ["https://sentry.vzkn.eu"]
        USE_X_FORWARDED_HOST = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
        CSRF_COOKIE_SECURE = True
        SESSION_COOKIE_SECURE = True
        SOCIAL_AUTH_REDIRECT_IS_HTTPS = True
        SENTRY_BEACON = False
        # Disable internal monitoring (causes timeout loops)
        import sentry_sdk
        sentry_sdk.init(dsn=None)

    # Sentry configuration
    sentry:
      features:
        orgSubdomains: false
        enableProfiling: true
        enableSessionReplay: true
        enableFeedback: true
        enableSpan: true
        enableUptime: false

      # Disable uptime consumer (feature is off)
      uptimeResults:
        enabled: false

      web:
        replicas: 1
        # Probe settings - give web time to start (loads plugins, connects to DBs)
        probeInitialDelaySeconds: 90
        probeFailureThreshold: 10
        probePeriodSeconds: 30
        probeTimeoutSeconds: 30
        resources:
          requests:
            cpu: 50m
            memory: 1Gi
          limits:
            memory: 4Gi

      worker:
        replicas: 1
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 4Gi

      cron:
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi

      # Task Broker (replaces RabbitMQ in 28.0.0)
      taskBroker:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi
        persistence:
          enabled: true
          size: 1Gi

      # Task Worker (replaces RabbitMQ in 28.0.0)
      taskWorker:
        enabled: true
        replicas: 1
        concurrency: 4
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 4Gi

      # Cleanup old data
      cleanup:
        enabled: true
        days: 90
        resources:
          requests:
            cpu: 25m
            memory: 256Mi
          limits:
            memory: 2Gi

      # Ingest Consumers
      ingestConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      ingestMonitors:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      ingestProfiles:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      ingestReplayRecordings:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      ingestOccurrences:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # Post-process Forwarders
      postProcessForwardErrors:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      postProcessForwardTransactions:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

      postProcessForwardIssuePlatform:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      # Subscription Consumers (alerts)
      subscriptionConsumerEvents:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

      subscriptionConsumerTransactions:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

    # Relay
    relay:
      replicas: 1
      resources:
        requests:
          cpu: 25m
          memory: 64Mi
        limits:
          memory: 256Mi

    # Snuba
    snuba:
      api:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      consumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      transactionsConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      metricsConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      profilesConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      replaysConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 1Gi

      outcomesConsumer:
        replicas: 1
        resources:
          requests:
            cpu: 25m
            memory: 128Mi
          limits:
            memory: 512Mi

    # Symbolicator
    symbolicator:
      enabled: true
      api:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi
        persistence:
          enabled: false

    # Sourcemaps
    sourcemaps:
      enabled: true

    # Vroom (profiling)
    vroom:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 25m
          memory: 64Mi
        limits:
          memory: 256Mi
      persistence:
        enabled: false

    # Nodestore S3 (new in 28.0.0)
    nodestore:
      backend: s3
      s3:
        bucketName: sentry
        bucketPath: nodestore
        endpointUrl: https://api.s3.vzkn.eu
        regionName: eu-central-1
        existingSecret: sentry-secret
        accessKeyIdRef: s3-access-key-id
        secretAccessKeyRef: s3-secret-access-key

    # Filestore S3
    filestore:
      backend: s3
      s3:
        bucketName: sentry
        endpointUrl: https://api.s3.vzkn.eu
        region: eu-central-1
        existingSecret: sentry-secret
        accessKeyIDKey: s3-access-key-id
        secretAccessKeyKey: s3-secret-access-key
      # Profiles storage (new in 28.0.0)
      profiles:
        backend: s3
        s3:
          bucketName: sentry
          bucketPath: profiles
          endpointUrl: https://api.s3.vzkn.eu
          regionName: eu-central-1
          existingSecret: sentry-secret
          accessKeyIdRef: s3-access-key-id
          secretAccessKeyRef: s3-secret-access-key
