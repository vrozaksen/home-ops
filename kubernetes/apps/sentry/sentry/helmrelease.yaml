---
# yaml-language-server: $schema=https://schemas.vzkn.eu/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: sentry
spec:
  interval: 1h
  url: https://sentry-kubernetes.github.io/charts
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sentry
spec:
  interval: 1h
  chart:
    spec:
      # renovate: registryUrl=https://sentry-kubernetes.github.io/charts
      chart: sentry
      version: 28.0.0
      sourceRef:
        kind: HelmRepository
        name: sentry
  values:
    # ============================================================================
    # YAML Anchors - Reusable Resource Definitions
    # ============================================================================
    # Tiny: background workers, schedulers
    x-resources-tiny: &resources-tiny
      requests:
        cpu: 25m
        memory: 128Mi
      limits:
        memory: 512Mi

    # Small: lightweight consumers
    x-resources-small: &resources-small
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi

    # Medium: standard consumers
    x-resources-medium: &resources-medium
      requests:
        cpu: 100m
        memory: 768Mi
      limits:
        memory: 3Gi

    # Large: web, main workers
    x-resources-large: &resources-large
      requests:
        cpu: 100m
        memory: 1Gi
      limits:
        memory: 4Gi

    # Web-specific (high memory)
    x-resources-web: &resources-web
      requests:
        cpu: 100m
        memory: 1536Mi
      limits:
        memory: 4Gi

    # Topology spread constraint template
    x-topology-spread: &topology-spread
      maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway

    # ============================================================================
    # Global Configuration
    # ============================================================================
    profiles:
      - feature-complete

    serviceAccount:
      enabled: true
      create: true
      name: sentry

    priorityClassName: cluster-low

    global:
      nodeSelector: {}
      tolerations: []

    # ============================================================================
    # Bundled Services - All Disabled (using external)
    # ============================================================================
    postgresql:
      enabled: false
    redis:
      enabled: false
    clickhouse:
      enabled: false
    zookeeper:
      enabled: false
    rabbitmq:
      enabled: false
    kafka:
      enabled: false
    nginx:
      enabled: false
    ingress:
      enabled: false
    pgbouncer:
      enabled: false

    # ============================================================================
    # GeoIP (MaxMind GeoLite2)
    # ============================================================================
    # PVC created separately in pvc.yaml (Helm uses existing via lookupVolumeName)
    geodata:
      accountID: ${MAXMIND_ACCOUNT_ID}
      licenseKey: ${MAXMIND_LICENSE_KEY}
      editionIDs: GeoLite2-City
      volumeName: geoip-data
      mountPath: /usr/share/GeoIP
      path: /usr/share/GeoIP/GeoLite2-City.mmdb
      persistence:
        storageClass: ceph-block
        size: 1Gi
        accessModes:
          - ReadWriteOnce
        lookupVolumeName: true

    # ============================================================================
    # External Services
    # ============================================================================
    # PostgreSQL via CloudNative-PG with PgBouncer pooler
    externalPostgresql:
      host: pooler-sentry-rw.sentry.svc.cluster.local
      port: 5432
      username: sentry
      database: sentry
      existingSecret: postgres-sentry-app
      existingSecretKeys:
        password: password

    # Redis via Dragonfly
    externalRedis:
      host: sentry-dragonfly.sentry.svc.cluster.local
      port: 6379
      db: 0

    # ClickHouse (single node)
    externalClickhouse:
      host: clickhouse.database.svc.cluster.local
      tcpPort: 9000
      httpPort: 8123
      username: clickhouse
      database: default
      singleNode: true
      existingSecret: sentry-secret
      existingSecretKey: clickhouse-password

    # Kafka via Strimzi
    externalKafka:
      host: sentry-kafka-kafka-bootstrap.sentry.svc.cluster.local
      port: 9092

    # ============================================================================
    # Hooks & Initialization
    # ============================================================================
    hooks:
      enabled: false
      dbCheck:
        enabled: true
      dbInit:
        enabled: false

    # ============================================================================
    # System & Auth Configuration
    # ============================================================================
    system:
      adminEmail: admin@sentry.vzkn.eu
      url: https://sentry.vzkn.eu
      public: false
      existingSecret: sentry-secret

    user:
      create: true
      email: admin@sentry.vzkn.eu
      existingSecret: sentry-secret
      existingSecretKey: ADMIN_PASSWORD

    auth:
      register: false

    # NOTE: Temporarily set to dummy to complete Welcome wizard (issue #1990) before setting up SMTP
    # After wizard completion, change back to smtp
    # mail:
    #   backend: dummy
    #   useTls: false
    #   useSsl: false
    #   username: ""
    #   password: ""
    #   # existingSecret: sentry-secret
    #   # existingSecretKey: mail-password
    #   port: 587
    #   host: ""
    #   from: ""
    mail:
      backend: smtp
      useTls: true
      useSsl: false
      username: "admin@vzkn.eu"
      password: ""
      existingSecret: sentry-secret
      existingSecretKey: mail-password
      port: 587
      host: "smtp.protonmail.ch"
      from: "admin@vzkn.eu"

    # ============================================================================
    # Application Configuration
    # ============================================================================
    config:
      sentryConfPy: |
        CSRF_TRUSTED_ORIGINS = ["https://sentry.vzkn.eu"]
        USE_X_FORWARDED_HOST = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
        CSRF_COOKIE_SECURE = True
        SESSION_COOKIE_SECURE = True
        SOCIAL_AUTH_REDIRECT_IS_HTTPS = True
        SENTRY_BEACON = False
        # Exempt SDK API endpoints from CSRF (they don't have Referer headers)
        CSRF_TRUSTED_ORIGINS += ["null"]  # For SDK requests without origin
        # Disable internal monitoring completely (causes timeout loops)
        import sentry_sdk
        sentry_sdk.init(
            dsn=None,
            default_integrations=False,
            auto_session_tracking=False,
            traces_sample_rate=0,
            profiles_sample_rate=0,
            send_default_pii=False,
        )
      web:
        httpKeepalive: 15
        httpChunkedInput: true
        workers: 3
        memoryReport: false
        maxRequests: 100000
        maxRequestsDelta: 500
        maxWorkerLifetime: 86400
        thunderLock: true
        logXForwardedFor: false
        bufferSize: 32768
        limitPost: 209715200
        disableLogging: true
        reloadOnRss: 600
        ignoreSignpipe: true
        ignoreWriteErrors: true
        disableWriteException: true

    # Disable internal self-monitoring
    extraEnv:
      - name: SENTRY_DSN
        value: ""
      - name: SENTRY_ENVIRONMENT
        value: ""
      - name: SENTRY_RELEASE
        value: ""
      - name: SENTRY_TRACES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_PROFILES_SAMPLE_RATE
        value: "0"
      - name: SENTRY_SEND_DEFAULT_PII
        value: "false"

    # ============================================================================
    # Storage (S3-compatible - Garage)
    # ============================================================================
    nodestore:
      backend: s3
      s3:
        bucketName: sentry
        bucketPath: nodestore
        endpointUrl: https://api.s3.vzkn.eu
        regionName: eu-central-1
        existingSecret: sentry-secret
        accessKeyIdRef: s3-access-key-id
        secretAccessKeyRef: s3-secret-access-key

    filestore:
      backend: s3
      s3:
        bucketName: sentry
        endpointUrl: https://api.s3.vzkn.eu
        region: eu-central-1
        existingSecret: sentry-secret
        accessKeyIDKey: s3-access-key-id
        secretAccessKeyKey: s3-secret-access-key

    # ============================================================================
    # Sentry Core Components
    # ============================================================================
    sentry:
      singleOrganization: true

      features:
        orgSubdomains: false
        enableProfiling: false      # Disabled - no vroom, no profile consumers
        enableSessionReplay: true   # Enabled - replay recordings
        enableFeedback: true        # Enabled - user feedback
        enableSpan: true            # Enabled - distributed tracing
        enableUptime: false         # Disabled - no uptime checker

      # ------------------------------------------
      # Web & API
      # ------------------------------------------
      web:
        replicas: 1
        resources: *resources-web
        probeInitialDelaySeconds: 180
        probeFailureThreshold: 20
        probePeriodSeconds: 30
        probeTimeoutSeconds: 60
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: web

      # ------------------------------------------
      # Task System (Celery replacement)
      # ------------------------------------------
      taskScheduler:
        enabled: true
        replicas: 1
        resources: *resources-tiny

      taskBroker:
        enabled: true
        replicas: 1
        resources: *resources-tiny
        persistence:
          enabled: true
          size: 1Gi

      taskWorker:
        enabled: true
        replicas: 1
        concurrency: 4
        resources: *resources-large

      # ------------------------------------------
      # Ingest Consumers (Kafka -> Processing)
      # ------------------------------------------
      ingestConsumerEvents:
        replicas: 1
        resources: *resources-medium
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: ingest-consumer-events

      ingestConsumerTransactions:
        replicas: 1
        resources: *resources-medium
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: ingest-consumer-transactions

      ingestConsumerAttachments:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: ingest-consumer-attachments

      ingestMonitors:
        replicas: 1
        resources: *resources-small

      ingestReplayRecordings:
        replicas: 1
        resources: *resources-small

      ingestOccurrences:
        replicas: 1
        resources: *resources-tiny

      ingestFeedback:
        enabled: true
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Processing
      # ------------------------------------------
      processSpans:
        replicas: 1
        resources: *resources-medium

      processSegments:
        enabled: true
        replicas: 1
        resources: *resources-small

      # ------------------------------------------
      # Post-Process Forwarders (Alerts)
      # ------------------------------------------
      postProcessForwardErrors:
        replicas: 1
        resources: *resources-small

      postProcessForwardTransactions:
        replicas: 1
        resources: *resources-small

      postProcessForwardIssuePlatform:
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Subscription Consumers (Alert Queries)
      # ------------------------------------------
      subscriptionConsumerEvents:
        replicas: 1
        resources: *resources-tiny

      subscriptionConsumerTransactions:
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Metrics Consumers
      # ------------------------------------------
      metricsConsumer:
        enabled: true  # Required for release health
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Cleanup
      # ------------------------------------------
      cleanup:
        enabled: true
        days: 90
        resources:
          requests:
            cpu: 25m
            memory: 256Mi
          limits:
            memory: 2Gi

      # ------------------------------------------
      # Disabled Sentry Components
      # ------------------------------------------
      # Profiling - disabled via features.enableProfiling
      ingestProfiles:
        enabled: false

      # Uptime - disabled via features.enableUptime
      uptimeResults:
        enabled: false

      # Billing - internal Sentry SaaS only
      billingMetricsConsumer:
        enabled: false

      # Generic metrics - not using custom SDK metrics
      genericMetricsConsumer:
        enabled: false

      # EAP subscription results
      subscriptionConsumerResultsEapItems:
        enabled: false

      # Generic metrics subscriptions
      subscriptionConsumerGenericMetrics:
        enabled: false
      subscriptionConsumerMetrics:
        enabled: false

      # Cron monitors (clock-based scheduling)
      monitorsClockTasks:
        enabled: false
      monitorsClockTick:
        enabled: false

    # ============================================================================
    # Relay (SDK ingestion proxy)
    # ============================================================================
    relay:
      replicas: 1
      resources: *resources-tiny
      topologySpreadConstraints:
        - <<: *topology-spread
          labelSelector:
            matchLabels:
              app: sentry
              role: relay

    # ============================================================================
    # Snuba (ClickHouse query layer)
    # ============================================================================
    snuba:
      # ------------------------------------------
      # API
      # ------------------------------------------
      api:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-api

      # ------------------------------------------
      # Main Consumers (Kafka -> ClickHouse)
      # ------------------------------------------
      consumer:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-consumer

      transactionsConsumer:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-transactions-consumer

      metricsConsumer:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-metrics-consumer

      replaysConsumer:
        replicas: 1
        resources: *resources-small
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-replays-consumer

      outcomesConsumer:
        replicas: 1
        resources: *resources-tiny
        topologySpreadConstraints:
          - <<: *topology-spread
            labelSelector:
              matchLabels:
                app: sentry
                role: snuba-outcomes-consumer

      # ------------------------------------------
      # Supporting Consumers
      # ------------------------------------------
      replacer:
        enabled: true
        replicas: 1
        resources: *resources-tiny

      issueOccurrenceConsumer:
        enabled: true
        replicas: 1
        resources: *resources-tiny

      groupAttributesConsumer:
        enabled: true
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Subscription Consumers (Alert Queries)
      # ------------------------------------------
      subscriptionConsumerEvents:
        replicas: 1
        resources: *resources-tiny

      subscriptionConsumerMetrics:
        replicas: 1
        resources: *resources-tiny

      subscriptionConsumerTransactions:
        replicas: 1
        resources: *resources-tiny

      # ------------------------------------------
      # Disabled Snuba Components
      # ------------------------------------------
      # Profiling consumers (enableProfiling: false)
      profilesConsumer:
        enabled: false
      profilingProfilesConsumer:
        enabled: false
      profilingFunctionsConsumer:
        enabled: false
      profilingChunksConsumer:
        enabled: false

      # EAP (experimental features)
      eapItemsConsumer:
        enabled: false
      subscriptionConsumerEapItems:
        enabled: false

      # Billing (Sentry SaaS internal)
      outcomesBillingConsumer:
        enabled: false

      # Generic metrics consumers (not using custom SDK metrics)
      genericMetricsGaugesConsumer:
        enabled: false
      genericMetricsCountersConsumer:
        enabled: false
      genericMetricsDistributionConsumer:
        enabled: false
      genericMetricsSetsConsumer:
        enabled: false

      # Generic metrics subscription consumers
      subscriptionConsumerGenericMetricsDistributions:
        enabled: false
      subscriptionConsumerGenericMetricsSets:
        enabled: false
      subscriptionConsumerGenericMetricsCounters:
        enabled: false
      subscriptionConsumerGenericMetricsGauges:
        enabled: false

    # ============================================================================
    # Symbolicator (Native crash symbolication)
    # ============================================================================
    symbolicator:
      enabled: true
      api:
        replicas: 1
        resources: *resources-small
        persistence:
          enabled: false

    # ============================================================================
    # Sourcemaps (JS error stack traces)
    # ============================================================================
    sourcemaps:
      enabled: true

    # ============================================================================
    # Disabled Components (via features)
    # ============================================================================
    # vroom - controlled by sentry.features.enableProfiling: false
    # uptimeChecker - controlled by sentry.features.enableUptime: false
