---
# yaml-language-server: $schema=https://schemas.vzkn.eu/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: sentry
spec:
  interval: 1h
  url: https://sentry-kubernetes.github.io/charts
---
# yaml-language-server: $schema=https://schemas.vzkn.eu/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sentry
spec:
  interval: 1h
  timeout: 15m
  chart:
    spec:
      # renovate: registryUrl=https://sentry-kubernetes.github.io/charts
      chart: sentry
      version: 29.3.0
      sourceRef:
        kind: HelmRepository
        name: sentry
  values:
    # ============================================================================
    # Global Configuration
    # ============================================================================
    profiles:
      - feature-complete

    serviceAccount:
      enabled: true
      create: true
      name: sentry

    priorityClassName: cluster-low

    # Schedule all Sentry components on workers only
    global:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: DoesNotExist
      topologySpreadConstraints:
        - maxSkew: 2
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/part-of: sentry

    # ============================================================================
    # Bundled Services - All Disabled (using external)
    # ============================================================================
    postgresql:
      enabled: false
    redis:
      enabled: false
    clickhouse:
      enabled: false
    zookeeper:
      enabled: false
    rabbitmq:
      enabled: false
    kafka:
      enabled: false
    nginx:
      enabled: false
    ingress:
      enabled: false
    pgbouncer:
      enabled: false

    # Gateway API HTTPRoute (chart-managed)
    route:
      main:
        enabled: true
        hostnames:
          - sentry.vzkn.eu
        parentRefs:
          - name: envoy-external
            namespace: network
            sectionName: https
      httpRedirect:
        enabled: true
        parentRefs:
          - name: envoy-external
            namespace: network
            sectionName: http

    # ============================================================================
    # External Services
    # ============================================================================
    # PostgreSQL via CloudNative-PG with PgBouncer pooler
    externalPostgresql:
      host: pooler-sentry-rw.sentry.svc.cluster.local
      port: 5432
      username: sentry
      database: sentry
      existingSecret: postgres-sentry-app
      existingSecretKeys:
        password: password

    # Redis via Dragonfly
    externalRedis:
      host: sentry-dragonfly.sentry.svc.cluster.local
      port: 6379
      db: 0

    # ClickHouse (single node)
    externalClickhouse:
      host: clickhouse.sentry.svc.cluster.local
      tcpPort: 9000
      httpPort: 8123
      username: clickhouse
      database: default
      singleNode: true
      existingSecret: sentry-secret
      existingSecretKey: clickhouse-password

    # Kafka (Confluent KRaft, in sentry namespace)
    externalKafka:
      host: kafka.sentry.svc.cluster.local
      port: 9092

    # ============================================================================
    # System & Auth Configuration
    # ============================================================================
    system:
      adminEmail: admin@vzkn.eu
      url: https://sentry.vzkn.eu
      public: false
      existingSecret: sentry-secret

    user:
      create: true
      email: admin@vzkn.eu
      existingSecret: sentry-secret
      existingSecretKey: ADMIN_PASSWORD

    auth:
      register: false

    # GitHub Integration (configured via sentryConfPy below)

    # NOTE: Temporarily set to dummy to complete Welcome wizard (issue #1990) before setting up SMTP
    # After wizard completion, change back to smtp
    # mail:
    #   backend: dummy
    #   useTls: false
    #   useSsl: false
    #   username: ""
    #   password: ""
    #   # existingSecret: sentry-secret
    #   # existingSecretKey: mail-password
    #   port: 587
    #   host: ""
    #   from: ""
    mail:
      backend: smtp
      useTls: true
      useSsl: false
      username: "admin@vzkn.eu"
      password: ""
      existingSecret: sentry-secret
      existingSecretKey: mail-password
      port: 587
      host: "smtp.protonmail.ch"
      from: "admin@vzkn.eu"

    # OpenAI for Sentry AI features (disabled - uncomment when needed)
    # openai:
    #   existingSecret: sentry-secret
    #   existingSecretKey: openai-api-key

    # ============================================================================
    # Application Configuration
    # ============================================================================
    config:
      sentryConfPy: |
        CSRF_TRUSTED_ORIGINS = ["https://sentry.vzkn.eu"]
        USE_X_FORWARDED_HOST = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
        CSRF_COOKIE_SECURE = True
        SESSION_COOKIE_SECURE = True
        SOCIAL_AUTH_REDIRECT_IS_HTTPS = True
        SENTRY_BEACON = False
        CSRF_TRUSTED_ORIGINS += ["null"]  # For SDK requests without origin

        # Disable external relay registration
        SENTRY_RELAY_OPEN_REGISTRATION = False
        SENTRY_RELAY_WHITELIST_PK = []

        # GitHub Integration
        if os.environ.get("GITHUB_APP_ID"):
            SENTRY_OPTIONS["github-app.id"] = int(os.environ["GITHUB_APP_ID"])
            SENTRY_OPTIONS["github-app.name"] = os.environ.get("GITHUB_APP_NAME", "sentry-vzkn-eu")
            SENTRY_OPTIONS["github-app.client-id"] = os.environ.get("GITHUB_CLIENT_ID", "")
            SENTRY_OPTIONS["github-app.client-secret"] = os.environ.get("GITHUB_CLIENT_SECRET", "")
            SENTRY_OPTIONS["github-app.webhook-secret"] = os.environ.get("GITHUB_WEBHOOK_SECRET", "")
            # Handle private key with escaped newlines
            private_key = os.environ.get("GITHUB_PRIVATE_KEY", "")
            SENTRY_OPTIONS["github-app.private-key"] = private_key.replace("\\n", "\n")

        # ===========================================
        # Feature Flags
        # ===========================================

        # Search & Discovery
        SENTRY_FEATURES["organizations:advanced-search"] = True
        SENTRY_FEATURES["organizations:discover-basic"] = True
        SENTRY_FEATURES["organizations:discover-query"] = True

        # Alerts & Monitoring
        SENTRY_FEATURES["organizations:anomaly-detection-alerts"] = True
        SENTRY_FEATURES["organizations:change-alerts"] = True
        SENTRY_FEATURES["organizations:crash-rate-alerts"] = True
        SENTRY_FEATURES["organizations:incidents"] = True
        SENTRY_FEATURES["organizations:uptime"] = False

        # Performance
        SENTRY_FEATURES["organizations:performance-view"] = True
        SENTRY_FEATURES["organizations:performance-trace-explorer"] = True
        SENTRY_FEATURES["organizations:performance-new-trends"] = True
        SENTRY_FEATURES["organizations:performance-spans-new-ui"] = True
        SENTRY_FEATURES["organizations:performance-transaction-summary-cleanup"] = True

        # Profiling - disabled for now (someday)
        SENTRY_FEATURES["organizations:profiling-view"] = False  # Someday
        SENTRY_FEATURES["organizations:continuous-profiling"] = False  # Someday
        SENTRY_FEATURES["organizations:continuous-profiling-beta"] = False  # Someday
        SENTRY_FEATURES["organizations:continuous-profiling-billing"] = False  # Someday
        SENTRY_FEATURES["organizations:profiling"] = False  # Someday
        SENTRY_FEATURES["organizations:profiling-browser"] = False  # Someday
        SENTRY_FEATURES["organizations:profiling-differential-flamegraph-page"] = False  # Someday

        # Session Replay
        SENTRY_FEATURES["organizations:session-replay"] = True
        SENTRY_FEATURES["organizations:session-replay-ui"] = True
        SENTRY_FEATURES["organizations:session-replay-recording-scrubbing"] = True
        SENTRY_FEATURES["organizations:replay-playlist-view"] = True

        # Integrations
        SENTRY_FEATURES["organizations:codecov-integration"] = True
        SENTRY_FEATURES["organizations:integrations-alert-rule"] = True
        SENTRY_FEATURES["organizations:integrations-chat-unfurl"] = True
        SENTRY_FEATURES["organizations:integrations-codeowners"] = True
        SENTRY_FEATURES["organizations:integrations-event-hooks"] = True
        SENTRY_FEATURES["organizations:integrations-enterprise-alert-rule"] = True
        SENTRY_FEATURES["organizations:integrations-enterprise-incident-management"] = True
        SENTRY_FEATURES["organizations:integrations-incident-management"] = True
        SENTRY_FEATURES["organizations:integrations-issue-basic"] = True
        SENTRY_FEATURES["organizations:integrations-issue-sync"] = True
        SENTRY_FEATURES["organizations:integrations-stacktrace-link"] = True
        SENTRY_FEATURES["organizations:integrations-ticket-rules"] = True

        # SSO
        SENTRY_FEATURES["organizations:sso-basic"] = False
        SENTRY_FEATURES["organizations:sso-saml2"] = True
        SENTRY_FEATURES["organizations:sso-saml2-slo"] = True

        # Data & Metrics
        SENTRY_FEATURES["organizations:custom-symbol-sources"] = True
        SENTRY_FEATURES["organizations:data-forwarding"] = True
        SENTRY_FEATURES["organizations:event-attachments"] = True
        SENTRY_FEATURES["organizations:custom-metrics"] = True
        SENTRY_FEATURES["organizations:dynamic-sampling"] = True
        SENTRY_FEATURES["organizations:dynamic-sampling-custom"] = True
        SENTRY_FEATURES["organizations:dynamic-sampling-minimum-sample-rate"] = True
        SENTRY_FEATURES["organizations:spans-usage-tracking"] = True
        SENTRY_FEATURES["organizations:on-demand-metrics-prefill"] = True
        SENTRY_FEATURES["organizations:relay"] = False

        # Teams & Orgs
        SENTRY_FEATURES["organizations:team-insights"] = True
        SENTRY_FEATURES["organizations:team-roles"] = True

        # Dashboards
        SENTRY_FEATURES["organizations:dashboards-basic"] = True
        SENTRY_FEATURES["organizations:dashboards-edit"] = True
        SENTRY_FEATURES["organizations:dashboards-global-filters"] = True
        SENTRY_FEATURES["organizations:dashboards-import"] = True
        SENTRY_FEATURES["organizations:dashboards-mep"] = True
        SENTRY_FEATURES["organizations:dashboards-prebuilt-controls"] = True

        # Insights
        SENTRY_FEATURES["organizations:insight-modules"] = True
        SENTRY_FEATURES["organizations:starfish-view"] = True
        SENTRY_FEATURES["organizations:starfish-mobile-appstart"] = True

        # Traces
        SENTRY_FEATURES["organizations:trace-view-v1"] = True
        SENTRY_FEATURES["organizations:trace-view-linked-traces"] = True

        # Logs (OurLogs)
        SENTRY_FEATURES["organizations:ourlogs-enabled"] = True
        SENTRY_FEATURES["organizations:ourlogs-ingestion"] = True
        SENTRY_FEATURES["organizations:ourlogs-stats"] = True
        SENTRY_FEATURES["organizations:ourlogs-replay-ui"] = True

        # Workflow Engine
        SENTRY_FEATURES["organizations:workflow-engine-ui"] = True
        SENTRY_FEATURES["organizations:workflow-engine-single-process-workflows"] = True

        # Other
        SENTRY_FEATURES["organizations:metric-alert-chartcuterie"] = True
        SENTRY_FEATURES["organizations:span-stats"] = True
        SENTRY_FEATURES["organizations:issue-views"] = True
        SENTRY_FEATURES["organizations:escalating-issues-v2"] = True
        SENTRY_FEATURES["organizations:related-events"] = True
        SENTRY_FEATURES["organizations:sdk-crash-detection"] = True
        SENTRY_FEATURES["organizations:suspect-commits-in-emails"] = True
        SENTRY_FEATURES["organizations:sentry-pride-logo-footer"] = False

        # Projects
        SENTRY_FEATURES["projects:data-forwarding"] = True
        SENTRY_FEATURES["projects:rate-limits"] = True
        SENTRY_FEATURES["projects:custom-inbound-filters"] = True
        SENTRY_FEATURES["projects:discard-groups"] = True
        SENTRY_FEATURES["projects:servicehooks"] = True

        # AI/Seer - disabled
        SENTRY_FEATURES["organizations:gen-ai-features"] = False
        SENTRY_FEATURES["organizations:autofix-seer-preferences"] = False
        SENTRY_FEATURES["projects:ai-autofix"] = False
        SENTRY_FEATURES["organizations:seer-explorer"] = False
        SENTRY_FEATURES["organizations:seer-autopilot"] = False
        SENTRY_FEATURES["organizations:seer-based-priority"] = False
        SENTRY_FEATURES["organizations:seer-coding-agent-integrations"] = False
        SENTRY_FEATURES["organizations:user-feedback-ai-summaries"] = False
        SENTRY_FEATURES["organizations:replay-ai-summaries"] = False
        SENTRY_FEATURES["organizations:gen-ai-explore-traces"] = False
        SENTRY_FEATURES["organizations:unlimited-auto-triggered-autofix-runs"] = False

        # S3-compatible storage settings for Garage
        import os
        os.environ.setdefault("AWS_REQUEST_CHECKSUM_CALCULATION", "when_required")
        os.environ.setdefault("AWS_RESPONSE_CHECKSUM_VALIDATION", "when_required")
        # Set AWS credentials from S3_* env vars for boto3
        if os.environ.get("S3_ACCESS_KEY_ID"):
            os.environ.setdefault("AWS_ACCESS_KEY_ID", os.environ["S3_ACCESS_KEY_ID"])
        if os.environ.get("S3_SECRET_ACCESS_KEY"):
            os.environ.setdefault("AWS_SECRET_ACCESS_KEY", os.environ["S3_SECRET_ACCESS_KEY"])

        # Override filestore options for Garage compatibility
        SENTRY_OPTIONS["filestore.options"] = {
            "access_key": os.environ.get("S3_ACCESS_KEY_ID", ""),
            "secret_key": os.environ.get("S3_SECRET_ACCESS_KEY", ""),
            "bucket_name": "sentry",
            "endpoint_url": "https://api.s3.vzkn.eu",
            "region_name": "eu-central-1",
            "addressing_style": "path",
            "signature_version": "s3v4",
        }

        # =============================================
        # Storage Backends - use same S3 as filestore
        # =============================================
        # Session Replay recordings
        SENTRY_OPTIONS["replay.storage.backend"] = "sentry.filestore.s3.S3Boto3Storage"
        SENTRY_OPTIONS["replay.storage.options"] = SENTRY_OPTIONS.get("filestore.options", {})

        # Chart rendering (alert emails with charts)
        SENTRY_OPTIONS["chart-rendering.storage.backend"] = "s3"
        SENTRY_OPTIONS["chart-rendering.storage.options"] = SENTRY_OPTIONS.get("filestore.options", {})

        # Configurations storage
        SENTRY_OPTIONS["configurations.storage.backend"] = "s3"
        SENTRY_OPTIONS["configurations.storage.options"] = SENTRY_OPTIONS.get("filestore.options", {})

        # Control silo filestore
        SENTRY_OPTIONS["filestore.control.backend"] = "s3"
        SENTRY_OPTIONS["filestore.control.options"] = SENTRY_OPTIONS.get("filestore.options", {})

      web:
        httpKeepalive: 15
        httpChunkedInput: true
        workers: 3
        memoryReport: false
        maxRequests: 100000
        maxRequestsDelta: 500
        maxWorkerLifetime: 86400
        thunderLock: true
        logXForwardedFor: false
        bufferSize: 32768
        limitPost: 209715200
        disableLogging: true
        reloadOnRss: 600
        ignoreSignpipe: true
        ignoreWriteErrors: true
        disableWriteException: true

    # ============================================================================
    # Storage (S3-compatible - Garage)
    # ============================================================================
    filestore:
      backend: s3
      s3:
        bucketName: sentry
        endpointUrl: https://api.s3.vzkn.eu
        region: eu-central-1
        existingSecret: sentry-secret
        accessKeyIDKey: s3-access-key-id
        secretAccessKeyKey: s3-secret-access-key

    # ============================================================================
    # Sentry Core Components
    # ============================================================================
    sentry:
      singleOrganization: true

      # Features control component auto-enablement
      features:
        orgSubdomains: false
        enableProfiling: false  # Auto-disables: vroom, ingestProfiles, profilesConsumer, profiling*Consumer
        enableSessionReplay: true  # Auto-enables: replaysConsumer, ingestReplayRecordings
        enableFeedback: true  # Auto-enables: ingestFeedback
        enableSpan: true  # Auto-enables: processSpans, processSegments
        enableUptime: false

      # Uptime monitoring - disabled
      uptimeResults:
        enabled: false

      # ------------------------------------------
      # Web & API
      # ------------------------------------------
      web:
        existingSecretEnv: sentry-github
        probeInitialDelaySeconds: 180
        probeFailureThreshold: 20
        probePeriodSeconds: 30
        probeTimeoutSeconds: 60

      # ------------------------------------------
      # Task System (replaces Celery)
      # ------------------------------------------
      taskWorker:
        concurrency: 4

      taskBroker:
        persistence:
          enabled: true
          size: 1Gi

      # ------------------------------------------
      # Cleanup
      # ------------------------------------------
      cleanup:
        days: 90

      # ------------------------------------------
      # Feedback
      # ------------------------------------------
      ingestFeedback:
        enabled: true

    # ============================================================================
    # Snuba (ClickHouse query layer)
    # ============================================================================
    snuba:
      rustConsumer: true

    # ============================================================================
    # Symbolicator (Native crash symbolication)
    # ============================================================================
    symbolicator:
      api:
        persistence:
          enabled: false
