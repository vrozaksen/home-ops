# ðŸ”’ Kubesec Security Scanner
# Automated security analysis for Kubernetes manifests
# This workflow uses actions that are not certified by GitHub.

name: ðŸ”’ Home-Ops Security Analysis

on:
  push:
    branches: [ "main" ]
    paths:
      - "kubernetes/**/*.yaml"
      - "kubernetes/**/*.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "kubernetes/**/*.yaml"
      - "kubernetes/**/*.yml"
  schedule:
    - cron: '26 23 * * 1'
  workflow_dispatch:

jobs:
  security-scan:
    name: ðŸ›¡ï¸ GitOps Security Analysis
    runs-on: home-ops-runner
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        # renovate: datasource=github-tags depName=actions/checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ðŸ” Discover GitOps Manifests
        id: discover
        run: |
          echo "ðŸ” Discovering GitOps manifests for security analysis..."

          # Find all YAML files in the repository
          find kubernetes/ \
            \( -name "*.yaml" -o -name "*.yml" \) \
            ! -name "kustomization.yaml" \
            ! -name "kustomization.yml" \
            ! -path "*/flux-system/*" \
            > all_manifests.txt

          TOTAL_COUNT=$(wc -l < all_manifests.txt)
          echo "ðŸ“Š Found $TOTAL_COUNT YAML files total"
          echo "total_manifests=$TOTAL_COUNT" >> $GITHUB_OUTPUT

          # Categorize files by type
          echo "ðŸ” Analyzing manifest types..."

          # HelmReleases
          HELM_COUNT=$(grep -l "kind:\s*HelmRelease" kubernetes/**/*.yaml kubernetes/**/*.yml 2>/dev/null | wc -l || echo "0")
          echo "helmrelease_count=$HELM_COUNT" >> $GITHUB_OUTPUT

          # Kustomizations
          KUSTOMIZATION_COUNT=$(grep -l "kind:\s*Kustomization" kubernetes/**/*.yaml kubernetes/**/*.yml 2>/dev/null | wc -l || echo "0")
          echo "kustomization_count=$KUSTOMIZATION_COUNT" >> $GITHUB_OUTPUT

          # ExternalSecrets
          EXTERNALSECRET_COUNT=$(grep -l "kind:\s*ExternalSecret" kubernetes/**/*.yaml kubernetes/**/*.yml 2>/dev/null | wc -l || echo "0")
          echo "externalsecret_count=$EXTERNALSECRET_COUNT" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Manifest breakdown:"
          echo "  ðŸ“¦ HelmReleases: $HELM_COUNT"
          echo "  ðŸ”§ Kustomizations: $KUSTOMIZATION_COUNT"
          echo "  ðŸ” ExternalSecrets: $EXTERNALSECRET_COUNT"

          if [ $TOTAL_COUNT -eq 0 ]; then
            echo "scan_needed=false" >> $GITHUB_OUTPUT
          else
            echo "scan_needed=true" >> $GITHUB_OUTPUT
          fi

          rm -f all_manifests.txt

      - name: ðŸ”’ Home-Ops Security Scanner
        id: scan
        if: steps.discover.outputs.scan_needed == 'true'
        run: |
          echo "ðŸ”’ Running custom Home-Ops security analysis..."

          # Initialize results
          SECURITY_ISSUES=()
          WARNINGS=()
          INFO_ITEMS=()
          CRITICAL_COUNT=0
          WARNING_COUNT=0
          INFO_COUNT=0

          echo "ðŸ” Analyzing HelmRelease configurations..."

          # Check for insecure HelmRelease configurations
          while IFS= read -r helmrelease; do
            echo "ï¿½ Scanning HelmRelease: $helmrelease"

            # Check for missing security contexts in values
            if ! grep -q "securityContext\|runAsNonRoot\|runAsUser" "$helmrelease" 2>/dev/null; then
              WARNINGS+=("$helmrelease: No securityContext found in values")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for missing resource limits
            if ! grep -q "resources:\|limits:\|requests:" "$helmrelease" 2>/dev/null; then
              WARNINGS+=("$helmrelease: No resource limits specified")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for potential privileged access
            if grep -q "privileged.*true\|allowPrivilegeEscalation.*true" "$helmrelease" 2>/dev/null; then
              SECURITY_ISSUES+=("$helmrelease: Privileged container configuration detected")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            fi

            # Check for hostNetwork
            if grep -q "hostNetwork.*true" "$helmrelease" 2>/dev/null; then
              SECURITY_ISSUES+=("$helmrelease: Host network access enabled")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            fi

            # Check for hostPath volumes
            if grep -q "hostPath:" "$helmrelease" 2>/dev/null; then
              WARNINGS+=("$helmrelease: Host path volume detected")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for latest image tags
            if grep -q "tag:\s*['\"]latest['\"]" "$helmrelease" 2>/dev/null; then
              WARNINGS+=("$helmrelease: Using 'latest' image tag - use specific versions")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for missing image pull policies
            if ! grep -q "imagePullPolicy" "$helmrelease" 2>/dev/null; then
              INFO_ITEMS+=("$helmrelease: Consider specifying imagePullPolicy")
              INFO_COUNT=$((INFO_COUNT + 1))
            fi

            # Check for missing read-only root filesystem
            if ! grep -q "readOnlyRootFilesystem.*true" "$helmrelease" 2>/dev/null; then
              INFO_ITEMS+=("$helmrelease: Consider enabling readOnlyRootFilesystem")
              INFO_COUNT=$((INFO_COUNT + 1))
            fi

            # Check for capabilities configuration
            if ! grep -q "capabilities:" "$helmrelease" 2>/dev/null; then
              INFO_ITEMS+=("$helmrelease: Consider configuring container capabilities (drop ALL)")
              INFO_COUNT=$((INFO_COUNT + 1))
            fi

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*HelmRelease" {} \; 2>/dev/null)

          echo "ðŸ” Analyzing Flux Source Security..."

          # Check HelmRepository sources
          while IFS= read -r helmrepo; do
            echo "ðŸ“¦ Scanning HelmRepository: $helmrepo"

            # Check for HTTPS URLs
            if ! grep -q "url:\s*https://" "$helmrepo" 2>/dev/null; then
              SECURITY_ISSUES+=("$helmrepo: HelmRepository not using HTTPS")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            fi

            # Check for signature verification
            if ! grep -q "verify:\|secretRef:" "$helmrepo" 2>/dev/null; then
              WARNINGS+=("$helmrepo: No signature verification configured")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check reconciliation interval (too frequent can cause DoS)
            if grep -q "interval:\s*[0-9]*[sm]" "$helmrepo" 2>/dev/null; then
              INTERVAL=$(grep -o "interval:\s*[0-9]*[sm]" "$helmrepo" 2>/dev/null | grep -o "[0-9]*[sm]")
              if [[ "$INTERVAL" =~ ^[0-9]+s$ ]] || [[ "$INTERVAL" =~ ^[1-4]m$ ]]; then
                WARNINGS+=("$helmrepo: Short reconciliation interval ($INTERVAL) may cause DoS")
                WARNING_COUNT=$((WARNING_COUNT + 1))
              fi
            fi

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*HelmRepository" {} \; 2>/dev/null)

          # Check GitRepository sources
          while IFS= read -r gitrepo; do
            echo "ðŸ“‚ Scanning GitRepository: $gitrepo"

            # Check for HTTPS URLs
            if ! grep -q "url:\s*https://" "$gitrepo" 2>/dev/null; then
              SECURITY_ISSUES+=("$gitrepo: GitRepository not using HTTPS")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            fi

            # Check for GPG verification
            if ! grep -q "verify:\|secretRef:" "$gitrepo" 2>/dev/null; then
              WARNINGS+=("$gitrepo: No GPG verification configured")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*GitRepository" {} \; 2>/dev/null)

          # Check OCIRepository sources
          while IFS= read -r ocirepo; do
            echo "ðŸ³ Scanning OCIRepository: $ocirepo"

            # Check for signature verification
            if ! grep -q "verify:" "$ocirepo" 2>/dev/null; then
              WARNINGS+=("$ocirepo: No OCI signature verification configured")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for cosign provider
            if grep -q "verify:" "$ocirepo" && ! grep -q "provider:\s*cosign" "$ocirepo" 2>/dev/null; then
              INFO_ITEMS+=("$ocirepo: Consider using cosign for OCI verification")
              INFO_COUNT=$((INFO_COUNT + 1))
            fi

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*OCIRepository" {} \; 2>/dev/null)

          echo "ðŸ” Analyzing ExternalSecret configurations..."

          # Check ExternalSecret security
          while IFS= read -r externalsecret; do
            echo "ðŸ” Scanning ExternalSecret: $externalsecret"

            # Check for proper secret store references
            if ! grep -q "secretStoreRef\|clusterSecretStoreRef" "$externalsecret" 2>/dev/null; then
              WARNINGS+=("$externalsecret: Missing secret store reference")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for refresh interval (security best practice)
            if ! grep -q "refreshInterval" "$externalsecret" 2>/dev/null; then
              INFO_ITEMS+=("$externalsecret: Consider adding refreshInterval for secret rotation")
              INFO_COUNT=$((INFO_COUNT + 1))
            fi

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*ExternalSecret" {} \; 2>/dev/null)

          echo "ðŸ›¡ï¸ Performing RBAC Security Analysis..."

          # Check ServiceAccounts and Roles
          while IFS= read -r rbacfile; do
            echo "ðŸ”‘ Scanning RBAC: $rbacfile"

            # Check for wildcard permissions
            if grep -q "resources:\s*\[.*\*.*\]" "$rbacfile" 2>/dev/null; then
              SECURITY_ISSUES+=("$rbacfile: Wildcard (*) permissions detected")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            fi

            # Check for cluster-admin role
            if grep -q "cluster-admin" "$rbacfile" 2>/dev/null; then
              WARNINGS+=("$rbacfile: cluster-admin role binding found")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for privileged verbs
            for verb in create delete deletecollection patch; do
              if grep -q "verbs:.*$verb" "$rbacfile" 2>/dev/null; then
                INFO_ITEMS+=("$rbacfile: Privileged verb '$verb' detected")
                INFO_COUNT=$((INFO_COUNT + 1))
              fi
            done

          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*\(Role\|ClusterRole\|RoleBinding\|ClusterRoleBinding\)" {} \; 2>/dev/null)

          echo "ðŸŒ Checking Network Security Policies..."

          # Check for NetworkPolicies
          NETPOL_COUNT=$(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*NetworkPolicy" {} \; 2>/dev/null | wc -l)
          APP_COUNT=$(find kubernetes/apps/ -maxdepth 1 -type d 2>/dev/null | wc -l)

          if [ "$NETPOL_COUNT" -lt $((APP_COUNT / 2)) ]; then
            WARNINGS+=("Network policies may be missing for some applications")
            WARNING_COUNT=$((WARNING_COUNT + 1))
          fi

          # Check for service mesh configurations
          if ! find kubernetes/ -name "*.yaml" -exec grep -l "istio\|linkerd\|consul" {} \; 2>/dev/null | head -1 > /dev/null; then
            INFO_ITEMS+=("Consider implementing a service mesh for enhanced security")
            INFO_COUNT=$((INFO_COUNT + 1))
          fi

          echo "ðŸ“Š Analyzing Image Security Policies..."

          # Check for ImagePolicy
          if ! find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*ImagePolicy" {} \; 2>/dev/null | head -1 > /dev/null; then
            WARNINGS+=("No Flux ImagePolicy found - consider implementing automated image updates")
            WARNING_COUNT=$((WARNING_COUNT + 1))
          fi

          # Check for PodSecurityStandards
          if ! find kubernetes/ -name "*.yaml" -exec grep -l "pod-security.kubernetes.io" {} \; 2>/dev/null | head -1 > /dev/null; then
            WARNINGS+=("Pod Security Standards labels not found - consider implementing PSS")
            WARNING_COUNT=$((WARNING_COUNT + 1))
          fi

          echo "ðŸ”’ Checking Certificate and TLS Security..."

          # Check for cert-manager certificates
          CERT_COUNT=$(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*Certificate" {} \; 2>/dev/null | wc -l)
          INGRESS_COUNT=$(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*Ingress" {} \; 2>/dev/null | wc -l)

          if [ "$INGRESS_COUNT" -gt 0 ] && [ "$CERT_COUNT" -eq 0 ]; then
            WARNINGS+=("Ingresses found but no cert-manager Certificates - TLS may not be automated")
            WARNING_COUNT=$((WARNING_COUNT + 1))
          fi

          # Check for HTTP-only services
          while IFS= read -r servicefile; do
            if grep -q "port:\s*80\|targetPort:\s*80" "$servicefile" 2>/dev/null; then
              if ! grep -q "port:\s*443\|targetPort:\s*443" "$servicefile" 2>/dev/null; then
                INFO_ITEMS+=("$servicefile: Service using HTTP port 80 without HTTPS")
                INFO_COUNT=$((INFO_COUNT + 1))
              fi
            fi
          done < <(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*Service" {} \; 2>/dev/null)

          echo "âš ï¸ Checking for Deprecated APIs..."

          # Check for deprecated API versions
          for api in "extensions/v1beta1" "apps/v1beta1" "apps/v1beta2" "networking.k8s.io/v1beta1"; do
            if find kubernetes/ -name "*.yaml" -exec grep -l "apiVersion:\s*$api" {} \; 2>/dev/null | head -1 > /dev/null; then
              WARNINGS+=("Deprecated API version found: $api")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi
          done

          echo "ðŸ” Analyzing general security patterns..."

          # Check for hardcoded secrets/tokens
          if HARDCODED_SECRETS=$(grep -r -i -E "(password|token|key|secret):\s*['\"]?[a-zA-Z0-9]{8,}" kubernetes/ --include="*.yaml" --include="*.yml" 2>/dev/null | grep -v "secretRef\|valueFrom\|secretKeyRef" | head -5); then
            if [ ! -z "$HARDCODED_SECRETS" ]; then
              SECURITY_ISSUES+=("Potential hardcoded secrets detected in YAML files")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
              echo "âš ï¸ Hardcoded secrets found:"
              echo "$HARDCODED_SECRETS" | while read -r line; do
                echo "  - $(echo "$line" | cut -d: -f1)"
              done
            fi
          fi

          # Check for default service accounts
          if DEFAULT_SA=$(grep -r "serviceAccountName:\s*default" kubernetes/ --include="*.yaml" --include="*.yml" 2>/dev/null); then
            WARNINGS+=("Default service account usage detected")
            WARNING_COUNT=$((WARNING_COUNT + 1))
          fi

          # Check for privileged containers
          echo "ðŸ” Checking for privileged containers..."
          PRIVILEGED_COUNT=0
          if PRIVILEGED_FILES=$(grep -r -l "privileged.*true" kubernetes/ 2>/dev/null); then
            PRIVILEGED_COUNT=$(echo "$PRIVILEGED_FILES" | wc -l)
            echo "âš ï¸ Found $PRIVILEGED_COUNT files with privileged containers:"
            echo "$PRIVILEGED_FILES" | while read -r file; do
              echo "  - $file"
              SECURITY_ISSUES+=("$file: Privileged container configuration detected")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            done
          else
            echo "âœ… No privileged containers found"
          fi

          # Check for hostNetwork usage
          echo "ðŸ” Checking for hostNetwork usage..."
          HOST_NETWORK_COUNT=0
          if HOST_NETWORK_FILES=$(grep -r -l "hostNetwork.*true" kubernetes/ 2>/dev/null); then
            HOST_NETWORK_COUNT=$(echo "$HOST_NETWORK_FILES" | wc -l)
            echo "âš ï¸ Found $HOST_NETWORK_COUNT files with hostNetwork usage:"
            echo "$HOST_NETWORK_FILES" | while read -r file; do
              echo "  - $file"
              SECURITY_ISSUES+=("$file: Host network access enabled")
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            done
          else
            echo "âœ… No hostNetwork usage found"
          fi

          # Check for root users
          echo "ðŸ” Checking for root users..."
          ROOT_USER_COUNT=0
          if ROOT_USER_FILES=$(grep -r -l "runAsUser.*0" kubernetes/ 2>/dev/null); then
            ROOT_USER_COUNT=$(echo "$ROOT_USER_FILES" | wc -l)
            echo "âš ï¸ Found $ROOT_USER_COUNT files with containers running as root:"
            echo "$ROOT_USER_FILES" | while read -r file; do
              echo "  - $file"
              WARNINGS+=("$file: Container running as root user")
              WARNING_COUNT=$((WARNING_COUNT + 1))
            done
          else
            echo "âœ… No root user containers found"
          fi

          # Check for missing network policies references
          if [ $(find kubernetes/ -name "*.yaml" -exec grep -l "kind:\s*NetworkPolicy" {} \; 2>/dev/null | wc -l) -eq 0 ]; then
            INFO_ITEMS+=("No NetworkPolicy resources found - consider implementing network segmentation")
            INFO_COUNT=$((INFO_COUNT + 1))
          fi

          # Create comprehensive SARIF output for all security findings
          echo "ðŸ“‹ Generating comprehensive SARIF results..."
          SARIF_RESULTS=""

          # Function to create stable fingerprint
          create_fingerprint() {
            local file_path="$1"
            local message="$2"
            local rule_id="$3"
            echo "${rule_id}:${file_path}:${message}" | sha256sum | cut -d' ' -f1
          }

          # Process critical security issues
          for issue in "${SECURITY_ISSUES[@]}"; do
            if [[ "$issue" == *":"* ]]; then
              file_path=$(echo "$issue" | cut -d: -f1)
              message=$(echo "$issue" | cut -d: -f2- | sed 's/"/\\"/g' | sed 's/^ *//')

              # Only add if file exists and path is valid
              if [ -f "$file_path" ]; then
                fingerprint=$(create_fingerprint "$file_path" "$message" "critical-security")
                SARIF_RESULTS="$SARIF_RESULTS{\"ruleId\":\"critical-security\",\"level\":\"error\",\"message\":{\"text\":\"$message\"},\"locations\":[{\"physicalLocation\":{\"artifactLocation\":{\"uri\":\"$file_path\"},\"region\":{\"startLine\":1}}}],\"fingerprints\":{\"home-ops-security\":\"$fingerprint\"}},"
              fi
            else
              # Skip general issues without specific file to reduce noise
              echo "â­ï¸ Skipping general critical issue: $issue"
            fi
          done

          # Process warnings - only file-specific ones
          for warning in "${WARNINGS[@]}"; do
            if [[ "$warning" == *":"* ]]; then
              file_path=$(echo "$warning" | cut -d: -f1)
              message=$(echo "$warning" | cut -d: -f2- | sed 's/"/\\"/g' | sed 's/^ *//')

              # Only add if file exists and path is valid
              if [ -f "$file_path" ]; then
                fingerprint=$(create_fingerprint "$file_path" "$message" "security-warning")
                SARIF_RESULTS="$SARIF_RESULTS{\"ruleId\":\"security-warning\",\"level\":\"warning\",\"message\":{\"text\":\"$message\"},\"locations\":[{\"physicalLocation\":{\"artifactLocation\":{\"uri\":\"$file_path\"},\"region\":{\"startLine\":1}}}],\"fingerprints\":{\"home-ops-security\":\"$fingerprint\"}},"
              fi
            else
              # Skip general warnings to reduce noise
              echo "â­ï¸ Skipping general warning: $warning"
            fi
          done

          # Skip Info items to reduce alert volume - only report Critical and Warning
          # Info items are logged but not added to SARIF

          # Log skipped info items for debugging
          if [ $INFO_COUNT -gt 0 ]; then
            echo "ðŸ“ Skipped $INFO_COUNT info items to reduce alert noise"
            echo "â„¹ï¸ Info items (logged only, not reported to security tab):"
            printf '  â€¢ %s\n' "${INFO_ITEMS[@]}"
          fi

          # Remove trailing comma if results exist
          if [ ! -z "$SARIF_RESULTS" ]; then
            SARIF_RESULTS=${SARIF_RESULTS%,}
          fi

          # Add timestamp to make fingerprints more stable across runs
          SCAN_TIMESTAMP=$(date -u '+%Y%m%d')

          cat > security-results.sarif << EOF
          {
            "version": "2.1.0",
            "\$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "home-ops-security-scanner",
                    "version": "2.0.0",
                    "informationUri": "https://github.com/vrozaksen/home-ops",
                    "shortDescription": {
                      "text": "Custom GitOps security scanner for home-ops repository"
                    },
                    "properties": {
                      "scanTimestamp": "$SCAN_TIMESTAMP"
                    },
                    "rules": [
                      {
                        "id": "critical-security",
                        "name": "Critical Security Issue",
                        "shortDescription": {
                          "text": "Critical security configuration issue requiring immediate attention"
                        },
                        "defaultConfiguration": {
                          "level": "error"
                        },
                        "help": {
                          "text": "This rule identifies critical security misconfigurations in Kubernetes manifests that require immediate attention."
                        }
                      },
                      {
                        "id": "security-warning",
                        "name": "Security Warning",
                        "shortDescription": {
                          "text": "Security configuration warning that should be reviewed"
                        },
                        "defaultConfiguration": {
                          "level": "warning"
                        },
                        "help": {
                          "text": "This rule identifies security configurations that could be improved but are not immediately critical."
                        }
                      }
                    ]
                  }
                },
                "results": [$SARIF_RESULTS]
              }
            ]
          }
          EOF

          echo "âœ… Home-Ops security scan completed!"
          echo "ðŸ“Š Security Analysis Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”´ Critical Issues: $CRITICAL_COUNT"
          echo "ðŸŸ¡ Warnings: $WARNING_COUNT"
          echo "â„¹ï¸  Info: $INFO_COUNT (not reported to avoid noise)"
          echo ""
          echo "ðŸ“ˆ Analysis Coverage:"
          echo "  â€¢ Flux CRDs (HelmRelease, Kustomization, ExternalSecret)"
          echo "  â€¢ Source Security (HelmRepository, GitRepository, OCIRepository)"
          echo "  â€¢ Container Security (Images, Capabilities, Filesystems)"
          echo "  â€¢ RBAC Analysis (Roles, Permissions, Service Accounts)"
          echo "  â€¢ Network Security (Policies, Service Mesh)"
          echo "  â€¢ Image Policies & Pod Security Standards"
          echo "  â€¢ Certificate Management & TLS"
          echo "  â€¢ Deprecated API Detection"
          echo "  â€¢ Secret Management & External Sources"
          echo ""
          echo "ðŸ“‹ SARIF Details:"
          if [ ! -z "$SARIF_RESULTS" ]; then
            SARIF_COUNT=$(echo "$SARIF_RESULTS" | tr ',' '\n' | grep -c '"ruleId"' || echo "0")
            echo "  â€¢ Generated $SARIF_COUNT SARIF result entries"
            echo "  â€¢ Category: home-ops-security"
            echo "  â€¢ Fingerprints enabled for deduplication"
          else
            echo "  â€¢ No SARIF results to upload (all issues were general or files missing)"
          fi

          # Output results for summary
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT
          echo "info_count=$INFO_COUNT" >> $GITHUB_OUTPUT
          echo "scanned_count=${{ steps.discover.outputs.total_manifests }}" >> $GITHUB_OUTPUT
          echo "privileged_containers=$PRIVILEGED_COUNT" >> $GITHUB_OUTPUT
          echo "host_network=$HOST_NETWORK_COUNT" >> $GITHUB_OUTPUT
          echo "root_users=$ROOT_USER_COUNT" >> $GITHUB_OUTPUT

          # Generate security summary
          ADDITIONAL_ISSUES=""
          if [ $PRIVILEGED_COUNT -gt 0 ]; then
            ADDITIONAL_ISSUES="${ADDITIONAL_ISSUES}Privileged containers: $PRIVILEGED_COUNT files; "
          fi
          if [ $HOST_NETWORK_COUNT -gt 0 ]; then
            ADDITIONAL_ISSUES="${ADDITIONAL_ISSUES}HostNetwork usage: $HOST_NETWORK_COUNT files; "
          fi
          if [ $ROOT_USER_COUNT -gt 0 ]; then
            ADDITIONAL_ISSUES="${ADDITIONAL_ISSUES}Root users: $ROOT_USER_COUNT files; "
          fi

          if [ -z "$ADDITIONAL_ISSUES" ]; then
            SECURITY_SUMMARY="âœ… All security checks passed"
          else
            SECURITY_SUMMARY="âš ï¸ Security issues found: $ADDITIONAL_ISSUES"
          fi
          echo "security_summary=$SECURITY_SUMMARY" >> $GITHUB_OUTPUT

          # Print findings
          if [ $CRITICAL_COUNT -gt 0 ]; then
            echo "ðŸ”´ Critical Security Issues:"
            printf '%s\n' "${SECURITY_ISSUES[@]}"
          fi

          if [ $WARNING_COUNT -gt 0 ]; then
            echo "ðŸŸ¡ Security Warnings:"
            printf '%s\n' "${WARNINGS[@]}"
          fi

          if [ $INFO_COUNT -gt 0 ]; then
            echo "ðŸŸ¢ Security Recommendations:"
            printf '%s\n' "${INFO_ITEMS[@]}"
          fi

      - name:  Generate Scan Summary
        if: steps.discover.outputs.scan_needed == 'true'
        run: |
          echo "## ðŸ”’ Home-Ops Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ  **Repository**: GitOps Home Operations" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Analyzed**: ${{ steps.discover.outputs.total_manifests }} YAML manifests" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ Manifest Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ï¿½ HelmReleases | ${{ steps.discover.outputs.helmrelease_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Kustomizations | ${{ steps.discover.outputs.kustomization_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” ExternalSecrets | ${{ steps.discover.outputs.externalsecret_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | ${{ steps.scan.outputs.critical_count || '0' }} | ${{ steps.scan.outputs.critical_count == '0' && 'âœ… None Found' || 'âš ï¸ Requires Attention' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Warnings | ${{ steps.scan.outputs.warning_count || '0' }} | ${{ steps.scan.outputs.warning_count == '0' && 'âœ… None Found' || 'ðŸ’¡ Recommendations' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Info | ${{ steps.scan.outputs.info_count || '0' }} | ${{ steps.scan.outputs.info_count == '0' && 'âœ… None Found' || 'ðŸ“‹ Suggestions' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Specific Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Privileged Containers | ${{ steps.scan.outputs.privileged_containers || '0' }} | ${{ steps.scan.outputs.privileged_containers == '0' && 'âœ… Safe' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Host Network Usage | ${{ steps.scan.outputs.host_network || '0' }} | ${{ steps.scan.outputs.host_network == '0' && 'âœ… Safe' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Root User Containers | ${{ steps.scan.outputs.root_users || '0' }} | ${{ steps.scan.outputs.root_users == '0' && 'âœ… Safe' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Security Status:** ${{ steps.scan.outputs.security_summary || 'No security scan data available' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "ðŸŽ¯ **Scanner**: Custom Home-Ops GitOps Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "ï¿½ **Runner**: home-ops-runner" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Security Results
        id: check_sarif
        if: steps.discover.outputs.scan_needed == 'true' && always()
        run: |
          # Check if we have any SARIF results to upload
          if [ -f "security-results.sarif" ]; then
            RESULT_COUNT=$(jq '.runs[0].results | length' security-results.sarif 2>/dev/null || echo "0")
            echo "ðŸ“Š SARIF file contains $RESULT_COUNT security results"

            if [ "$RESULT_COUNT" -gt 0 ]; then
              echo "ðŸ“¤ Uploading security results to GitHub Security tab..."
              echo "sarif_upload_needed=true" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ No security results to upload - skipping SARIF upload"
              echo "sarif_upload_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SARIF file not found - skipping upload"
            echo "sarif_upload_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload SARIF to GitHub Security
        if: steps.discover.outputs.scan_needed == 'true' && always() && steps.check_sarif.outputs.sarif_upload_needed == 'true'
        # renovate: datasource=github-tags depName=github/codeql-action
        uses: github/codeql-action/upload-sarif@4e828ff8d448a8a6e532957b1811f387a63867e8 # v3.29.4
        with:
          sarif_file: security-results.sarif
          category: home-ops-security

      - name: âš ï¸ Skip Notification
        if: steps.discover.outputs.scan_needed == 'false'
        run: |
          echo "## ðŸ”’ Home-Ops Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **No YAML manifests found to analyze**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is unexpected for a GitOps repository. Please check:" >> $GITHUB_STEP_SUMMARY
          echo "- The kubernetes/ directory exists" >> $GITHUB_STEP_SUMMARY
          echo "- YAML files are present in the repository" >> $GITHUB_STEP_SUMMARY
          echo "- File permissions allow reading" >> $GITHUB_STEP_SUMMARY
