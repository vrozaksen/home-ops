---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Update Sentry Kafka Topics

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Every Monday at 6:00 UTC

env:
  UV_SYSTEM_PYTHON: "1"

permissions:
  contents: read

jobs:
  update-topics:
    name: Update Kafka Topics
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.13"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Clone sentry-kafka-schemas
        run: |
          git clone --depth 1 https://github.com/getsentry/sentry-kafka-schemas.git /tmp/sentry-kafka-schemas

      - name: Generate Kafka topics ConfigMap
        run: |
          python3 scripts/generate-kafka-topics.py \
            --source /tmp/sentry-kafka-schemas/topics \
            --output kubernetes/apps/sentry/kafka/topics-configmap.yaml

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet kubernetes/apps/sentry/kafka/topics-configmap.yaml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "### Changed topics:" >> "$GITHUB_STEP_SUMMARY"
            git diff kubernetes/apps/sentry/kafka/topics-configmap.yaml >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@67ccf781d68cd99b580ae25a5c18a1cc84ffff1f # v7.0.6
        with:
          commit-message: "feat(sentry): update Kafka topics from sentry-kafka-schemas"
          title: "Update Sentry Kafka Topics"
          body: |
            Automated update of Sentry Kafka topics from [sentry-kafka-schemas](https://github.com/getsentry/sentry-kafka-schemas).

            This PR was generated by the `sentry-kafka-topics` workflow.
          branch: update-sentry-kafka-topics
          labels: |
            kafka
            sentry
            automated
          delete-branch: true
